<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tab-title">المحاسبة والمخازن</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="rtl" id="body-tag">


    <div id="login-overlay" class="login-screen">
    <div class="login-box">
        <img src="logo.png" alt="Logo" class="login-logo">
        <h2 id="login-title">تسجيل الدخول للنظام</h2>
        <div class="pin-display">
            <input type="password" id="pin-input" readonly placeholder="******">
        </div>
        <div class="pin-pad">
            <button onclick="appendPin('1')">1</button>
            <button onclick="appendPin('2')">2</button>
            <button onclick="appendPin('3')">3</button>
            <button onclick="appendPin('4')">4</button>
            <button onclick="appendPin('5')">5</button>
            <button onclick="appendPin('6')">6</button>
            <button onclick="appendPin('7')">7</button>
            <button onclick="appendPin('8')">8</button>
            <button onclick="appendPin('9')">9</button>
            <button class="btn-clear" onclick="clearPin()">C</button>
            <button onclick="appendPin('0')">0</button>
            <button class="btn-login" onclick="checkLogin()">Enter</button>
        </div>
        <p id="login-error" style="color: #e94560; margin-top: 15px; display: none;">الرمز غير صحيح!</p>
    </div>
</div>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="logo.png" alt="Logo" style="width: 80px;">
            </div>

            <a href="#" class="sidebar-item" id="menu-orders" onclick="loadPage('orders')"><i class="fas fa-receipt"></i> الطلبات</a>
            <a class="sidebar-item" id="menu-customers" onclick="loadPage('customers')">العملاء</a>
            <a class="sidebar-item" id="menu-products" onclick="loadPage('products')">المنتجات</a>
            <a class="sidebar-item" id="menu-categories" onclick="loadPage('categories')">التصنيفات</a>
            <a class="sidebar-item" id="menu-units" onclick="loadPage('units')">الوحدات</a>
            <a class="sidebar-item" id="menu-itemcard" onclick="loadPage('itemcard')">بطاقة الصنف</a>

            <div class="sidebar-item dropdown-btn" onclick="toggleDropdown('drop-stores')">
                <span id="menu-stores-title">المخازن</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="drop-stores" class="dropdown-container">
                <a href="#" class="sidebar-item" id="sub-inv-items" onclick="loadPage('inv-items')">مواد المخزون</a>
                <a class="sidebar-item" id="sub-storage-locations">أماكن التخزين</a>
                <a class="sidebar-item" id="sub-disbursement">صرف</a>
                <a class="sidebar-item" id="sub-production">انتاج</a>
                <a class="sidebar-item" id="sub-inventory-check">جرد</a>
                <a class="sidebar-item" id="sub-transfers">تحويلات</a>
                <a class="sidebar-item" id="sub-return-store">مرتجع للمخزن</a>
                <a class="sidebar-item" id="sub-return-waste">مرتجع توالف</a>
            </div>

            <div class="sidebar-item dropdown-btn" onclick="toggleDropdown('drop-suppliers')">
                <span id="menu-suppliers-title">الموردون</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="drop-suppliers" class="dropdown-container">
                <a class="sidebar-item" id="sub-suppliers-list">الموردون</a>
                <a class="sidebar-item" id="sub-purchasing">الشراء</a>
                <a class="sidebar-item" id="sub-return-supplier">مرتجع للمورد</a>
            </div>

            <div class="sidebar-item dropdown-btn" onclick="toggleDropdown('drop-admin')">
                <span id="menu-admin-title">الإدارة</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="drop-admin" class="dropdown-container">
                <a class="sidebar-item" id="sub-pending-moves">حركات مخزون معلقة</a>
                <a class="sidebar-item" id="sub-pos-devices" onclick="loadPOSDevicesPage()">الأجهزة والكاشير</a>
                <a class="sidebar-item" id="sub-store-staff" onclick="loadUsersPage()">المستخدمين</a>
                <a class="sidebar-item" id="sub-prod-staff">موظفي الانتاج</a>
                <a class="sidebar-item" id="sub-branches" onclick="loadBranchesPage()">الفروع</a>
                <a class="sidebar-item" id="sub-delivery-areas" onclick="loadDeliveryAreasPage()">مناطق التوصيل</a>
<a class="sidebar-item" id="sub-delivery-prices" onclick="loadDeliveryPricesPage()">أسعار التوصيل</a>
                <a class="sidebar-item" id="sub-discounts">خصومات</a>
                <a class="sidebar-item" id="sub-payment-types">انواع الطلب وطرق الدفع</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <h2 id="page-title">المحاسبة والمخازن</h2>
                <button id="btn-lang-toggle" class="btn-main" onclick="toggleLanguage()" style="padding: 5px 15px;">English</button>
            </header>
            
            <div id="content-area">
                <p id="welcome-msg">اختر قسماً من القائمة الجانبية للبدء...</p>
            </div>
        </main>
    </div>

    <script>
        // 1. قاموس الترجمة الشامل
        const translations = {
            ar: {
                tabTitle: "المحاسبة والمخازن",
                pageTitle: "المحاسبة والمخازن",
                btnLang: "English",
                welcome: "اختر قسماً من القائمة الجانبية للبدء...",
                orders: "الطلبات",
                customers: "العملاء",
                products: "المنتجات",
                categories: "التصنيفات",
                units: "الوحدات",
                itemcard: "بطاقة الصنف",
                storesTitle: "المخازن",
                invItems: "مواد المخزون",
                storageLoc: "أماكن التخزين",
                disbursement: "صرف",
                production: "انتاج",
                invCheck: "جرد",
                transfers: "تحويلات",
                retStore: "مرتجع للمخزن",
                retWaste: "مرتجع توالف",
                suppTitle: "الموردون",
                suppList: "الموردون",
                purchasing: "الشراء",
                retSupp: "مرتجع للمورد",
                adminTitle: "الإدارة",
                pendingMoves: "حركات مخزون معلقة",
                posDevices: "الأجهزة والكاشير",
                storeStaff: "موظفي المخازن",
                prodStaff: "موظفي الانتاج",
                branches: "الفروع",
                delAreas: "مناطق التوصيل",
                delPrices: "أسعار التوصيل",
                discounts: "خصومات",
                paymentTypes: "انواع الطلب وطرق الدفع",
                posTitle: "إدارة الأجهزة والفروع",
        posInfo: "هنا تظهر جميع الأجهزة التي فتحت النظام. يجب تحديد فرع لكل جهاز لكي يعمل.",
        deviceId: "ID الجهاز",
        status: "الحالة",
        assignedBranch: "الفرع المخصص",
        lastSeen: "آخر ظهور",
        actions: "إجراءات",
        cashierTitle: "إدارة الكاشير",
        addCashier: "+ إضافة كاشير جديد",
        cashierName: "اسم الكاشير",
        pin: "الرمز (PIN)",
        userTitle: "إدارة المستخدمين والصلاحيات",
        addUser: "+ إضافة مستخدم جديد",
        userName: "الاسم",
        userRole: "الدور (الصلاحية)",
        userPin: "رمز الدخول",
        branchTitle: "إدارة الفروع",
        addBranch: "+ إضافة فرع جديد",
        branchInfo: "يجب تحديد فرع واحد فقط كـ 'فرع رئيسي' ليكون مركز استلام المشتريات والمخزون الأولي.",
        nameAr: "الاسم (عربي)",
        nameEn: "الاسم (En)",
        type: "النوع",
        link: "ربط",
        edit: "تعديل",
        delete: "حذف",
        roleManager: "مدير",
        roleStorekeeper: "أمين مخازن",
        roleCashier: "أمين صندوق",
        modalAddUser: "إضافة مستخدم جديد",
        placeholderName: "اسم الموظف",
        placeholderPin: "رمز الدخول (4 أرقام)",
        saveSuccess: "✅ تم حفظ البيانات بنجاح",
        deleteConfirm: "هل أنت متأكد من الحذف؟",
        mainBranchLabel: "تعيين كفرع رئيسي",
        delAreasTitle: "إدارة مناطق وأسعار التوصيل",
    addAreaBtn: "+ إضافة منطقة جديدة",
    areaNameAr: "اسم المنطقة (عربي)",
    areaNameEn: "اسم المنطقة (En)",
    deliveryPrice: "سعر التوصيل",
    modalAddArea: "إضافة منطقة توصيل جديدة",
    modalEditArea: "تعديل منطقة التوصيل",
    placeholderPrice: "0.000",
    saveBtn: "حفظ المنطقة",
areaName: "المنطقة",
    customerCount: "عدد الزبائن",
    addArea: "إضافة منطقة جديدة",
    goToCustomers: "عرض الزبائن",
    delAreasTitle: "إدارة مناطق التوصيل",
    delPricesTitle: "إدارة أسعار التوصيل",
    addAreaBtn: "+ إضافة منطقة جديدة",
    addPriceBtn: "+ إضافة سعر جديد",
    areaNameAr: "اسم المنطقة (عربي)",
    areaNameEn: "اسم المنطقة (En)",
    customerCount: "عدد الزبائن",
    deliveryPrice: "سعر التوصيل",
    areaName: "المناطق المشمولة",
    viewCustomers: "عرض الزبائن",
    saveArea: "حفظ المنطقة",
    savePrice: "حفظ السعر",
    importBtn: "استيراد من إكسل",
    downloadTemplate: "تحميل النموذج",
    searchArea: "ابحث عن اسم المنطقة...",
    importProgress: "تم إضافة {count} من {total} منطقة",
    duplicateSkip: "تم تخطي المناطق الموجودة مسبقاً",
        orderNo: "رقم الفاتورة",
    orderNet: "صافي الفاتورة",
    orderDelivery: "قيمة التوصيل",
    orderTotal: "إجمالي الفاتورة",
    payMethod: "طريقة الدفع",
    filterFrom: "من تاريخ",
    filterTo: "إلى تاريخ",
    printInvoices: "طباعة الفواتير",
    exportOrders: "تحميل تقرير الطلبات",
    noOrders: "لا توجد طلبات متوافقة مع البحث"
        
            },
            en: {
                tabTitle: "Accounting System",
                pageTitle: "Accounting & Stores",
                btnLang: "عربي",
                welcome: "Select a department from the sidebar to start...",
                orders: "Orders",
                customers: "Customers",
                products: "Products",
                categories: "Categories",
                units: "Units",
                itemcard: "Item Card",
                storesTitle: "Stores",
                invItems: "Inventory Items",
                storageLoc: "Storage Locations",
                disbursement: "Disbursement",
                production: "Production",
                invCheck: "Inventory Check",
                transfers: "Transfers",
                retStore: "Store Return",
                retWaste: "Waste Return",
                suppTitle: "Suppliers",
                suppList: "Suppliers List",
                purchasing: "Purchasing",
                retSupp: "Supplier Return",
                adminTitle: "Admin",
                pendingMoves: "Pending Inventory",
                posDevices: "POS Devices",
                storeStaff: "Store Staff",
                prodStaff: "Production Staff",
                branches: "Branches",
                delAreas: "Delivery Areas",
                delPrices: "Delivery Prices",
                discounts: "Discounts",
                paymentTypes: "Payment & Order Types",
                posTitle: "Devices & Branches Management",
        posInfo: "All devices that accessed the system. A branch must be assigned to each device to work.",
        deviceId: "Device ID",
        status: "Status",
        assignedBranch: "Assigned Branch",
        lastSeen: "Last Seen",
        actions: "Actions",
        cashierTitle: "Cashier Management",
        addCashier: "+ Add New Cashier",
        cashierName: "Cashier Name",
        pin: "PIN Code",
        userTitle: "Users & Permissions",
        addUser: "+ Add New User",
        userName: "Name",
        userRole: "Role",
        userPin: "Entry PIN",
        branchTitle: "Branch Management",
        addBranch: "+ Add New Branch",
        branchInfo: "Only one branch must be set as 'Main Branch' for receiving inventory.",
        nameAr: "Name (Ar)",
        nameEn: "Name (En)",
        type: "Type",
        link: "Link",
        edit: "Edit",
        delete: "Delete",
        roleManager: "Manager",
        roleStorekeeper: "Storekeeper",
        roleCashier: "Cashier",
        modalAddUser: "Add New User",
        placeholderName: "Employee Name",
        placeholderPin: "PIN Code (4 Digits)",
        saveSuccess: "✅ Data saved successfully",
        deleteConfirm: "Are you sure you want to delete?",
        mainBranchLabel: "Set as Main Branch",
        delAreasTitle: "Delivery Areas & Prices",
    addAreaBtn: "+ Add New Area",
    areaNameAr: "Area Name (Ar)",
    areaNameEn: "Area Name (En)",
    deliveryPrice: "Delivery Fee",
    modalAddArea: "Add New Delivery Area",
    modalEditArea: "Edit Delivery Area",
    placeholderPrice: "0.000",
    saveBtn: "Save Area",
    areaName: "Area",
    customerCount: "Customer Count",
    addArea: "Add New Area",
    goToCustomers: "View Customers",
    delAreasTitle: "Delivery Areas",
    delPricesTitle: "Delivery Prices",
    addAreaBtn: "+ Add New Area",
    addPriceBtn: "+ Add New Price",
    areaNameAr: "Area Name (Ar)",
    areaNameEn: "Area Name (En)",
    customerCount: "Customers",
    deliveryPrice: "Delivery Fee",
    areaName: "Included Areas",
    viewCustomers: "View Customers",
    saveArea: "Save Area",
    savePrice: "Save Price",
    importBtn: "Import from Excel",
    downloadTemplate: "Download Template",
    searchArea: "Search for area name...",
    importProgress: "Added {count} of {total} areas",
    duplicateSkip: "Pre-existing areas were skipped",
        orderNo: "Invoice #",
    orderNet: "Net Amount",
    orderDelivery: "Delivery Fee",
    orderTotal: "Total Amount",
    payMethod: "Payment Method",
    filterFrom: "From Date",
    filterTo: "To Date",
    printInvoices: "Print Invoices",
    exportOrders: "Export Orders Report",
    noOrders: "No orders matching search criteria"
            }
        };

        let currentLang = 'ar';

        // 2. وظيفة تبديل اللغة (تحديث كل الـ IDs)
        window.toggleLanguage = function() {
            currentLang = (currentLang === 'ar') ? 'en' : 'ar';
            const body = document.getElementById('body-tag');
            body.className = (currentLang === 'ar') ? 'rtl' : 'ltr';
            
            const lang = translations[currentLang];

            // تحديث كل عنصر بناءً على الـ ID الخاص به
            document.getElementById('tab-title').innerText = lang.tabTitle;
            document.getElementById('page-title').innerText = lang.pageTitle;
            document.getElementById('btn-lang-toggle').innerText = lang.btnLang;
            if(document.getElementById('welcome-msg')) document.getElementById('welcome-msg').innerText = lang.welcome;

            document.getElementById('menu-orders').innerText = lang.orders;
            document.getElementById('menu-customers').innerText = lang.customers;
            document.getElementById('menu-products').innerText = lang.products;
            document.getElementById('menu-categories').innerText = lang.categories;
            document.getElementById('menu-units').innerText = lang.units;
            document.getElementById('menu-itemcard').innerText = lang.itemcard;

            document.getElementById('menu-stores-title').innerText = lang.storesTitle;
            document.getElementById('sub-inv-items').innerText = lang.invItems;
            document.getElementById('sub-storage-locations').innerText = lang.storageLoc;
            document.getElementById('sub-disbursement').innerText = lang.disbursement;
            document.getElementById('sub-production').innerText = lang.production;
            document.getElementById('sub-inventory-check').innerText = lang.invCheck;
            document.getElementById('sub-transfers').innerText = lang.transfers;
            document.getElementById('sub-return-store').innerText = lang.retStore;
            document.getElementById('sub-return-waste').innerText = lang.retWaste;

            document.getElementById('menu-suppliers-title').innerText = lang.suppTitle;
            document.getElementById('sub-suppliers-list').innerText = lang.suppList;
            document.getElementById('sub-purchasing').innerText = lang.purchasing;
            document.getElementById('sub-return-supplier').innerText = lang.retSupp;

            document.getElementById('menu-admin-title').innerText = lang.adminTitle;
            document.getElementById('sub-pending-moves').innerText = lang.pendingMoves;
            document.getElementById('sub-pos-devices').innerText = lang.posDevices;
            document.getElementById('sub-store-staff').innerText = lang.storeStaff;
            document.getElementById('sub-prod-staff').innerText = lang.prodStaff;
            document.getElementById('sub-branches').innerText = lang.branches;
            document.getElementById('sub-delivery-areas').innerText = lang.delAreas;
            document.getElementById('sub-delivery-prices').innerText = lang.delPrices;
            document.getElementById('sub-discounts').innerText = lang.discounts;
            document.getElementById('sub-payment-types').innerText = lang.paymentTypes;
        };

        // وظيفة القوائم المنسدلة
        window.loadPage = function(pageId) {
    // 1. إزالة التحديد من جميع العناصر (للمحافظة على شكل القائمة الجانبية)
    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    
    // 2. إضافة التحديد للعنصر المختار (ليظهر باللون النشط)
    const activeItem = document.getElementById('menu-' + pageId) || document.getElementById('sub-' + pageId);
    if (activeItem) activeItem.classList.add('active');

    // 3. توجيه الأوامر لفتح الصفحات بناءً على الـ ID
    if (pageId === 'products') {
        // تفعيل صفحة المنتجات والمخزون
        loadProductsPage(); 
    } 
    else if (pageId === 'customers') {
        loadCustomersPage();
    } 
    else if (pageId === 'orders') {
        loadOrdersPage();
    } 
    else if (pageId === 'cashier') {
    window.location.href = 'Cashier.html'; // الانتقال للملف الجديد بدلاً من تحميل دالة مفقودة
}
    else if (pageId === 'units') {
    loadUnitsPage();
}
else if (pageId === 'categories') {
    window.categoryPath = []; // تصفير المسار عند الدخول لأول مرة
    loadCategoriesPage();
}
else if (pageId === 'inv-items') {
    loadInventoryItemsPage();
}
};

        // --- كود نظام الدخول والتعرف على الجهاز ---
    let pinCode = "";

    window.appendPin = function(num) {
        if (pinCode.length < 6) {
            pinCode += num;
            document.getElementById('pin-input').value = "*".repeat(pinCode.length);
        }
    }

    window.clearPin = function() {
        pinCode = "";
        document.getElementById('pin-input').value = "";
        document.getElementById('login-error').style.display = "none";
    }

    window.checkLogin = function() {
    const errorMsg = document.getElementById('login-error');
    // استدعاء وظيفة التحقق الموجودة في الموديول
    if (window.verifyUserLogin) {
        window.verifyUserLogin(pinCode);
    } else {
        console.error("محرك الدخول لم يكتمل تحميله بعد");
    }
}

    function proceedToSystem() {
        document.getElementById('login-overlay').style.display = "none";
        checkDeviceBinding();
    }


    // فحص حالة الدخول عند تحميل الصفحة
    window.addEventListener('DOMContentLoaded', (event) => {
        if (sessionStorage.getItem('userRole')) {
            document.getElementById('login-overlay').style.display = "none";
        }
    });


    // نافذة إضافة "كاشير" (لنظام المبيعات فقط)
window.openAddCashierModal = function() {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>إضافة كاشير جديد (مبيعات)</h3>
                <input type="text" id="cashier-name-input" placeholder="اسم الكاشير">
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="cashier-pin-input" placeholder="رمز الدخول (4 أرقام)" maxlength="4">
                    <button class="btn-main" onclick="generateCashierPin()">إنشاء رمز</button>
                </div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveNewCashier()">حفظ الكاشير</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// دالة إنشاء رمز من 4 أرقام تلقائياً
window.generateCashierPin = function() {
    const pin = Math.floor(1000 + Math.random() * 9000); // توليد 4 أرقام
    document.getElementById('cashier-pin-input').value = pin;
};

window.closeModal = function() {
    const modal = document.getElementById('modal-overlay');
    if (modal) modal.remove();
}

window.generateRandomPin = function() {
    const pin = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('cashier-pin').value = pin;
}



    // أضف هذه الدوال في السكربت العادي (الدوال العامة)

window.loadPOSDevicesPage = function() {
    const lang = translations[currentLang]; 
    let html = `
        <div class="admin-section">
            <h3><i class="fas fa-network-wired"></i> ${lang.posTitle}</h3>
            <div class="info-card">${lang.posInfo}</div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.deviceId}</th>
                        <th>${lang.status}</th>
                        <th>${lang.assignedBranch}</th>
                        <th>${lang.lastSeen}</th>
                        <th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="devices-live-list"></tbody>
            </table>

            <hr style="margin: 40px 0; border: 0; border-top: 1px dashed rgba(255,255,255,0.1);">

            <div class="header-flex">
                <h3><i class="fas fa-users-cog"></i> ${lang.cashierTitle}</h3>
                <button class="btn-main" onclick="openAddCashierModal()">${lang.addCashier}</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.cashierName}</th>
                        <th>${lang.pin}</th>
                        <th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="cashiers-list-body"></tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    if(window.initDevicesAndCashiers) window.initDevicesAndCashiers();
};




window.editDevice = function(id) {
    alert("تعديل الجهاز رقم: " + id);
}



window.openEditDeviceModal = function(deviceId, currentBranch) {
    let branchesOptions = '<option value="">-- اختر فرعاً --</option>';
    
    // استخدام الأفرع التي تم جلبها من فايربيس
    if (window.availableBranches) {
        for (let id in window.availableBranches) {
            const b = window.availableBranches[id];
            branchesOptions += `<option value="${id}">${b.nameAr}</option>`;
        }
    }

    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>ربط الجهاز بفرع</h3>
                <p style="font-size:12px; color:#aaa;">الجهاز: ${deviceId}</p>
                <select id="select-branch-link" style="width:100%; padding:10px; background:#1a1a2e; color:white;">
                    ${branchesOptions}
                </select>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmLink('${deviceId}')">حفظ الربط</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// استبدل الدالة الموجودة في السكربت العلوي بهذا
window.confirmLink = function(deviceId) {
    const select = document.getElementById('select-branch-link');
    const branchId = select.value;
    const branchName = select.options[select.selectedIndex].text;
    
    if (!branchId) { 
        alert(currentLang === 'ar' ? "يرجى اختيار فرع أولاً" : "Please select a branch"); 
        return; 
    }
    
    // إرسال البيانات للمحرك في الموديول
    if (window.updateDeviceLink) {
        window.updateDeviceLink(deviceId, branchId, branchName);
    }
};



window.loadBranchesPage = function() {
    const lang = translations[currentLang]; // أضف هذا السطر
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-store"></i> ${lang.branchTitle}</h3> <button class="btn-main" onclick="openAddBranchModal()">${lang.addBranch}</button> </div>
            <div class="info-card" style="margin-top:10px;">
                <i class="fas fa-info-circle"></i> ${lang.branchInfo} </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.nameAr}</th><th>${lang.nameEn}</th><th>${lang.type}</th><th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="branches-list-body">
                    <tr><td colspan="4">...</td></tr>
                </tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    // استدعاء دالة جلب البيانات من الموديول
    // استبدل السطر الأخير في دالة loadBranchesPage بهذا الكود الذكي:
if (window.listenToBranches) {
    window.listenToBranches();
} else {
    // إذا لم يحمل الموديول بعد، انتظر ثانية وحاول مجدداً
    setTimeout(() => { if(window.listenToBranches) window.listenToBranches(); }, 1000);
}
};

window.openAddPriceModal = function() {
    const lang = translations[currentLang];
    
    // جلب المناطق من قاعدة البيانات لبناء القائمة
    get(ref(database, 'delivery_areas')).then((snap) => {
        const areas = snap.val() || {};
        let areasCheckboxes = "";
        
        for (let id in areas) {
            // تنسيق احترافي لكل خيار منطقة مع Flexbox
            areasCheckboxes += `
                <label style="display:flex; align-items:center; gap:12px; padding:10px; margin-bottom:8px; background:rgba(255,255,255,0.05); border-radius:5px; cursor:pointer; direction:rtl;">
                    <input type="checkbox" class="area-checkbox" value="${id}" style="width:18px; height:18px; accent-color:#f39c12;"> 
                    <span style="color:white; font-size:14px;">${currentLang === 'ar' ? areas[id].nameAr : areas[id].nameEn}</span>
                </label>`;
        }

        let modalHtml = `
            <div id="modal-overlay" class="modal-overlay">
                <div class="modal-box">
                    <h3>${lang.addPriceBtn}</h3>
                    
                    <input type="number" id="price-value" placeholder="0.000" step="0.005" style="margin-bottom:15px;">
                    
                    <div style="margin-bottom:10px;">
                        <input type="text" id="area-search" oninput="filterAreasInModal()" 
                               placeholder="${lang.searchArea || 'ابحث عن المنطقة...'}" 
                               style="width:100%; padding:10px; background:#0f0f1e; border:1px solid #444; color:white; border-radius:5px; outline:none;">
                    </div>

                    <div id="areas-container" style="text-align:right; max-height:200px; overflow-y:auto; margin:15px 0; border:1px solid #444; padding:10px; background: #16213e; border-radius:5px;">
                        <p style="color:#aaa; margin-bottom:10px; font-size:13px;">${currentLang === 'ar' ? 'اختر المناطق المشمولة:' : 'Select included areas:'}</p>
                        ${areasCheckboxes}
                    </div>

                    <div style="margin-top:20px; display:flex; justify-content: space-around; gap:10px;">
                        <button class="btn-login" onclick="confirmSavePrice()">${lang.savePrice}</button>
                        <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    });
};

// لا تنسَ إضافة دالة الفلترة هذه أيضاً في السكربت العادي لكي يعمل البحث
window.filterAreasInModal = function() {
    const searchValue = document.getElementById('area-search').value.toLowerCase();
    const container = document.getElementById('areas-container');
    const labels = container.getElementsByTagName('label');

    for (let label of labels) {
        const areaName = label.innerText.toLowerCase();
        // إظهار أو إخفاء المنطقة بناءً على نص البحث
        if (areaName.includes(searchValue)) {
            label.style.display = "flex";
        } else {
            label.style.display = "none";
        }
    }
};

window.confirmSavePrice = async function() {
    const priceInput = document.getElementById('price-value');
    const price = priceInput.value;
    const selectedCheckboxes = document.querySelectorAll('.area-checkbox:checked');
    const areaIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (!price || areaIds.length === 0) {
        alert(currentLang === 'ar' ? "يرجى إدخال السعر واختيار منطقة واحدة على الأقل" : "Please enter price and select at least one area");
        return;
    }

    const priceId = Date.now();
    try {
        // نستخدم window.set التي جعلناها عالمية
        await set(ref(database, 'delivery_prices/' + priceId), {
            price: price,
            areaIds: areaIds
        });
        alert(translations[currentLang].saveSuccess);
        closeModal();
    } catch (e) {
        alert("Error: " + e.message);
    }
};

window.openEditPriceModal = function(id, currentPrice, currentAreaIds) {
    const lang = translations[currentLang];
    
    get(ref(database, 'delivery_areas')).then((snap) => {
        const areas = snap.val() || {};
        let areasCheckboxes = "";
        
        for (let areaId in areas) {
            const isChecked = currentAreaIds.includes(areaId) ? 'checked' : '';
            areasCheckboxes += `
                <label style="display:flex; align-items:center; gap:12px; padding:10px; margin-bottom:8px; background:rgba(255,255,255,0.05); border-radius:5px; cursor:pointer; direction:rtl;">
                    <input type="checkbox" class="edit-area-checkbox" value="${areaId}" ${isChecked} style="width:18px; height:18px; accent-color:#f39c12;"> 
                    <span style="color:white; font-size:14px;">${currentLang === 'ar' ? areas[areaId].nameAr : areas[areaId].nameEn}</span>
                </label>`;
        }

        let modalHtml = `
            <div id="modal-overlay" class="modal-overlay">
                <div class="modal-box">
                    <h3>${lang.modalEditArea}</h3>
                    <input type="number" id="edit-price-value" value="${currentPrice}" placeholder="0.000" step="0.005">
                    
                    <div style="margin:15px 0 10px 0;">
                        <input type="text" id="area-search-edit" oninput="filterAreasInEditModal()" 
                               placeholder="${lang.searchArea}" 
                               style="width:100%; padding:10px; background:#0f0f1e; border:1px solid #444; color:white; border-radius:5px;">
                    </div>

                    <div id="edit-areas-container" style="text-align:right; max-height:200px; overflow-y:auto; margin:15px 0; border:1px solid #444; padding:10px; background:#16213e; border-radius:5px;">
                        ${areasCheckboxes}
                    </div>

                    <div style="margin-top:20px; display:flex; justify-content: space-around; gap:10px;">
                        <button class="btn-main" onclick="confirmPriceUpdate('${id}')">${lang.edit}</button>
                        <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    });
};

// دالة الفلترة الخاصة بنافذة التعديل
window.filterAreasInEditModal = function() {
    const searchValue = document.getElementById('area-search-edit').value.toLowerCase();
    const container = document.getElementById('edit-areas-container');
    const labels = container.getElementsByTagName('label');

    for (let label of labels) {
        const areaName = label.innerText.toLowerCase();
        label.style.display = areaName.includes(searchValue) ? "flex" : "none";
    }
};

// وظيفة جمع البيانات الجديدة وإرسالها للموديول
window.confirmPriceUpdate = function(id) {
    const newPrice = document.getElementById('edit-price-value').value;
    const selectedCheckboxes = document.querySelectorAll('.edit-area-checkbox:checked');
    const newAreaIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (!newPrice || newAreaIds.length === 0) {
        alert(currentLang === 'ar' ? "يرجى إدخال السعر واختيار منطقة واحدة على الأقل" : "Please enter price and select at least one area");
        return;
    }

    if (window.updatePriceInFirebase) {
        window.updatePriceInFirebase(id, newPrice, newAreaIds);
    }
};

window.openAddBranchModal = function() {
    const lang = translations[currentLang];
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.addBranch}</h3>
                <input type="text" id="branch-ar" placeholder="${lang.nameAr}">
                <input type="text" id="branch-en" placeholder="${lang.nameEn}">
                <label style="color:white; display:block; margin-top:15px; text-align:right;">
                    <input type="checkbox" id="is-main-branch"> ${lang.mainBranchLabel}
                </label>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveNewBranch()">${lang.addUser}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};
    


// وظيفة فتح نافذة تعديل الفرع
window.openEditBranchModal = function(id, nameAr, nameEn, isMain) {
    // تحويل القيمة النصية لـ isMain إلى Boolean للتحقق منها في الـ Checkbox
    const checked = isMain === 'true' ? 'checked' : '';
    
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>تعديل بيانات الفرع</h3>
                <input type="text" id="edit-branch-ar" value="${nameAr}" placeholder="اسم الفرع بالعربي">
                <input type="text" id="edit-branch-en" value="${nameEn}" placeholder="Branch Name (English)">
                <label style="color:white; display:block; margin-top:15px; text-align:right;">
                    <input type="checkbox" id="edit-is-main-branch" ${checked}> تعيين كفرع رئيسي
                </label>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmBranchUpdate('${id}')">حفظ التغييرات</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// وظيفة تأكيد التعديل وجمع البيانات الجديدة
window.confirmBranchUpdate = function(id) {
    const nameAr = document.getElementById('edit-branch-ar').value;
    const nameEn = document.getElementById('edit-branch-en').value;
    const isMain = document.getElementById('edit-is-main-branch').checked;

    if (!nameAr || !nameEn) {
        alert("يرجى إكمال الحقول المطلوبة");
        return;
    }

    // استدعاء وظيفة التحديث الموجودة في الموديول
    if (window.updateBranchInFirebase) {
        window.updateBranchInFirebase(id, nameAr, nameEn, isMain);
    }
}



// 1. واجهة إدارة المستخدمين
window.loadUsersPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-user-shield"></i> ${lang.userTitle}</h3>
                <button class="btn-main" onclick="openAddUserModal()">${lang.addUser}</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr><th>${lang.userName}</th><th>${lang.userRole}</th><th>${lang.userPin}</th><th>${lang.actions}</th></tr>
                </thead>
                <tbody id="users-list-body"></tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    window.initUsersLogic();
};

window.openAddUserModal = function() {
    const lang = translations[currentLang]; // استدعاء اللغة الحالية
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.addUser}</h3>
                <input type="text" id="user-name-input" placeholder="${lang.placeholderName}">
                <select id="user-role-select" style="width:100%; padding:10px; margin-top:15px; background:#1a1a2e; color:white;">
                    <option value="أمين صندوق">${lang.roleCashier}</option>
                    <option value="أمين مخازن">${lang.roleStorekeeper}</option>
                    <option value="مدير">${lang.roleManager}</option>
                </select>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="user-pin-input" placeholder="${lang.placeholderPin}" maxlength="4">
                    <button class="btn-main" onclick="generateUserPin()">${lang.link}</button>
                </div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmSaveUser()">${lang.edit}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// دالة توليد رمز من 4 أرقام للمستخدمين

window.generateUserPin = function() {

    const pin = Math.floor(1000 + Math.random() * 9000); 

    document.getElementById('user-pin-input').value = pin;

};

// 2. نافذة تعديل مستخدم (أصلحت لتستقبل البيانات)
window.openEditUserModal = function(pin, name, role) {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>تعديل مستخدم</h3>
                <p>الرمز: ${pin}</p>
                <input type="text" id="edit-user-name" value="${name}">
                <select id="edit-user-role" style="width:100%; padding:10px; margin-top:10px; background:#1a1a2e; color:white;">
                    <option value="أمين صندوق" ${role === 'أمين صندوق' ? 'selected' : ''}>أمين صندوق</option>
                    <option value="أمين مخازن" ${role === 'أمين مخازن' ? 'selected' : ''}>أمين مخازن</option>
                    <option value="مدير" ${role === 'مدير' ? 'selected' : ''}>مدير</option>
                </select>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmUserUpdate('${pin}')">تعديل</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// 3. نافذة تعديل الكاشير (التي كانت تسبب الخطأ)
window.openEditCashierModal = function(pin, name) {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>تعديل بيانات الكاشير</h3>
                <p>الرمز: ${pin}</p>
                <input type="text" id="edit-cashier-name" value="${name}">
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmCashierUpdate('${pin}')">حفظ</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.confirmUserUpdate = function(pin) {
    const name = document.getElementById('edit-user-name').value;
    const role = document.getElementById('edit-user-role').value;
    if (!name) return alert("يرجى إدخال الاسم");
    // استدعاء دالة التحديث الموجودة داخل الموديول
    if (window.updateUserInFirebase) window.updateUserInFirebase(pin, name, role);
};

// 2. جسر تعديل الكاشير
window.confirmCashierUpdate = function(pin) {
    const name = document.getElementById('edit-cashier-name').value;
    if (!name) return alert("يرجى إدخال الاسم");
    // استدعاء دالة التحديث الموجودة داخل الموديول
    if (window.updateCashierInFirebase) window.updateCashierInFirebase(pin, name);
};

window.loadDeliveryAreasPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex" style="gap:10px;">
                <h3><i class="fas fa-map-marker-alt"></i> ${lang.delAreasTitle}</h3>
                <div>
                    <button class="btn-main" onclick="openAddAreaModal()">${lang.addAreaBtn}</button>
                    <button class="btn-main" style="background:#27ae60;" onclick="triggerExcelUpload()">
                        <i class="fas fa-file-excel"></i> ${lang.importBtn}
                    </button>
                    <button class="btn-clear" onclick="downloadExcelTemplate()" style="font-size:12px;">${lang.downloadTemplate}</button>
                    <input type="file" id="excel-upload" style="display:none" accept=".xlsx, .xls" onchange="handleExcelImport(event)">
                </div>
            </div>
            <div id="import-status" style="margin:10px 0; color:#f39c12; font-weight:bold;"></div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.areaNameAr}</th>
                        <th>${lang.areaNameEn}</th>
                        <th>${lang.deliveryPrice}</th> <th>${lang.customerCount}</th>
                        <th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="delivery-areas-list"></tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    if(window.initDeliveryAreasLogic) window.initDeliveryAreasLogic();
};


window.loadDeliveryPricesPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-tags"></i> ${lang.delPricesTitle}</h3>
                <button class="btn-main" onclick="openAddPriceModal()">${lang.addPriceBtn}</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.deliveryPrice}</th>
                        <th>${lang.areaName}</th>
                        <th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="delivery-prices-list"></tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    if(window.initDeliveryPricesLogic) window.initDeliveryPricesLogic(); // استدعاء المحرك
};

// دالة نافذة التعديل (يجب إضافتها هنا)
window.openEditAreaModal = function(id, nameAr, nameEn) {
    const lang = translations[currentLang];
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.modalEditArea}</h3>
                <div style="margin-bottom:15px;">
                    <label style="color:#aaa; display:block; margin-bottom:5px; font-size:12px;">${lang.areaNameAr}</label>
                    <input type="text" id="edit-area-ar" value="${nameAr}" placeholder="${lang.areaNameAr}">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#aaa; display:block; margin-bottom:5px; font-size:12px;">${lang.areaNameEn}</label>
                    <input type="text" id="edit-area-en" value="${nameEn}" placeholder="${lang.areaNameEn}">
                </div>
                
                <div style="margin-top:20px; display:flex; justify-content: space-around; gap:10px;">
                    <button class="btn-main" onclick="confirmAreaUpdate('${id}')">${lang.edit}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.confirmAreaUpdate = function(id) {
    const nameAr = document.getElementById('edit-area-ar').value;
    const nameEn = document.getElementById('edit-area-en').value;

    // تأكد من أننا نرسل الاسمين فقط للموديول
    if (window.updateAreaInFirebase) {
        window.updateAreaInFirebase(id, nameAr, nameEn);
    }
};


window.openAddAreaModal = function() {
    const lang = translations[currentLang];
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.modalAddArea}</h3>
                <input type="text" id="area-name-ar" placeholder="${lang.areaNameAr}">
                <input type="text" id="area-name-en" placeholder="${lang.areaNameEn}">
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmSaveArea()">${lang.saveArea}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.loadCustomersPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex" style="display:flex; justify-content:space-between; align-items:center;">
                <h3><i class="fas fa-users"></i> ${lang.customers}</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn-main" style="background:#27ae60;" onclick="exportCustomersToExcel()">
                        <i class="fas fa-file-download"></i> تحميل التقرير (Excel)
                    </button>
                </div>
            </div>
            
            <div style="margin:20px 0; display:flex; gap:10px;">
                <button class="btn-main" onclick="filterCustomers('all')">الكل</button>
                <button class="btn-main" style="background:#ffd700; color:#000;" onclick="filterCustomers('vvip')">VVIP ★</button>
                <button class="btn-main" style="background:#c0c0c0; color:#000;" onclick="filterCustomers('vip')">VIP</button>
                <button class="btn-main" style="background:#e94560;" onclick="filterCustomers('blocked')">الموقوفين</button>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-cust" onclick="toggleSelectAllCustomers(this)"></th>
                        <th>الزبون / الهاتف</th>
                        <th>التصنيف</th>
                        <th>الإحصائيات</th>
                        <th>آخر طلب</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody id="customers-list-body"></tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    if(window.initCustomersLogic) window.initCustomersLogic();
};

window.openBlockModal = function(id, name) {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>إيقاف العميل: ${name}</h3>
                <textarea id="block-reason" placeholder="اكتب سبب الإيقاف هنا..." style="width:100%; height:80px; background:#1a1a2e; color:white; border:1px solid #e94560; border-radius:8px; padding:10px;"></textarea>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-clear" onclick="confirmBlockCustomer('${id}')">تأكيد الإيقاف</button>
                    <button class="btn-main" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.exportCustomersToExcel = function() {
    const lang = translations[currentLang];
    
    // 1. جلب جميع الصفوف التي تم تحديدها (Checkboxes)
    const selectedCheckboxes = document.querySelectorAll('.cust-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert(currentLang === 'ar' ? "يرجى تحديد عميل واحد على الأقل" : "Please select at least one customer");
        return;
    }

    // 2. تجهيز رأس الجدول (Headers)
    const data = [
        ["الاسم", "رقم الهاتف", "التصنيف", "عدد الطلبات", "متوسط الفاتورة", "آخر ظهور"]
    ];

    // 3. استخراج البيانات من الصفوف المختارة
    selectedCheckboxes.forEach(cb => {
        const row = cb.closest('tr');
        const name = row.querySelector('td:nth-child(2) div:first-child').innerText;
        const phone = row.querySelector('td:nth-child(2) div:last-child').innerText;
        const rank = row.querySelector('.rank-badge').innerText;
        const stats = row.querySelector('td:nth-child(4)').innerText.replace(/\n/g, ' ');
        const lastOrder = row.querySelector('td:nth-child(5)').innerText;

        data.push([name, phone, rank, stats, "", lastOrder]);
    });

    // 4. تحويل البيانات إلى ملف إكسل باستخدام مكتبة XLSX
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Customers Report");

    // 5. تحميل الملف باسم المخبز
    XLSX.writeFile(workbook, `Figs_Olives_Customers_${Date.now()}.xlsx`);
};


window.toggleSelectAllCustomers = function(source) {
    const checkboxes = document.querySelectorAll('.cust-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
};


window.loadOrdersPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex no-print" style="margin-bottom:20px;">
                <h3><i class="fas fa-receipt"></i> ${lang.orders}</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn-main" style="background:#27ae60;" onclick="exportOrdersToExcel()">
                        <i class="fas fa-file-excel"></i> ${lang.exportOrders}
                    </button>
                    <button class="btn-main" onclick="printSelectedInvoices()">
                        <i class="fas fa-print"></i> ${lang.printInvoices}
                    </button>
                </div>
            </div>

            <div class="info-card no-print" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; background:#fff;">
                <div>
                    <label style="font-size:12px; color:var(--text-muted);">${lang.filterFrom}</label>
                    <input type="date" id="filter-date-from" onchange="filterOrders()">
                </div>
                <div>
                    <label style="font-size:12px; color:var(--text-muted);">${lang.filterTo}</label>
                    <input type="date" id="filter-date-to" onchange="filterOrders()">
                </div>
                <select id="filter-cashier" onchange="filterOrders()">
                    <option value="">-- كل الكاشير --</option>
                </select>
                <select id="filter-branch" onchange="filterOrders()">
                    <option value="">-- كل الفروع --</option>
                </select>
                <select id="filter-area" onchange="filterOrders()">
                    <option value="">-- كل المناطق --</option>
                </select>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" onclick="toggleSelectAllOrders(this)"></th>
                        <th>${lang.orderNo}</th>
                        <th>العميل / المنطقة</th>
                        <th>التاريخ / الكاشير / الفرع</th>
                        <th>المبالغ (د.ك)</th>
                        <th>الدفع</th>
                        <th class="no-print">إجراءات</th>
                    </tr>
                </thead>
                <tbody id="orders-list-body"></tbody>
            </table>
        </div>
        <div id="print-area" class="only-print" style="display:none;"></div>`;
    document.getElementById('content-area').innerHTML = html;
    if(window.initOrdersLogic) window.initOrdersLogic();
};



window.printSelectedInvoices = function() {
    const selected = document.querySelectorAll('.order-checkbox:checked');
    if (selected.length === 0) return alert("اختر طلبات للطباعة");

    let printHtml = `
        <style>
            @media print {
                .invoice-page { page-break-after: always; padding: 20px; direction: rtl; font-family: 'Cairo', sans-serif; }
                .no-print { display: none !important; }
            }
        </style>`;

    selected.forEach(cb => {
        const orderId = cb.dataset.id;
        const order = window.allOrdersData[orderId];
        printHtml += `
            <div class="invoice-page">
                <center>
                    <img src="logo.png" style="width:80px;">
                    <h2>Figs & Olives Bakery</h2>
                    <p>فاتورة رقم: #${order.invoiceNo}</p>
                </center>
                <hr>
                <p>التاريخ: ${order.date} ${order.time}</p>
                <p>العميل: ${order.custName} (${order.phone})</p>
                <p>العنوان: ${order.areaName}</p>
                <table style="width:100%; border-collapse: collapse; margin-top:20px;">
                    <thead><tr style="border-bottom:1px solid #000;"><th>المنتج</th><th>الكمية</th><th>السعر</th></tr></thead>
                    <tbody>
                        ${order.items.map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>${parseFloat(i.price).toFixed(3)}</td></tr>`).join('')}
                    </tbody>
                </table>
                <hr>
                <div style="text-align:left;">
                    <p>الصافي: ${parseFloat(order.net).toFixed(3)} د.ك</p>
                    <p>التوصيل: ${parseFloat(order.delivery).toFixed(3)} د.ك</p>
                    <h3>الإجمالي: ${parseFloat(order.total).toFixed(3)} د.ك</h3>
                </div>
            </div>`;
    });

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHtml);
    printWindow.document.close();
    printWindow.print();
};



window.filterOrders = function() {
    const from = document.getElementById('filter-date-from').value;
    const to = document.getElementById('filter-date-to').value;
    const cashier = document.getElementById('filter-cashier').value;
    const branch = document.getElementById('filter-branch').value;
    const area = document.getElementById('filter-area').value;

    let filtered = Object.entries(window.allOrdersData).filter(([id, order]) => {
        let match = true;
        if (from && order.date < from) match = false;
        if (to && order.date > to) match = false;
        if (cashier && order.cashierId !== cashier) match = false;
        if (branch && order.branchId !== branch) match = false;
        if (area && order.areaId !== area) match = false;
        return match;
    });

    renderOrdersTable(Object.fromEntries(filtered));
};


// تُضاف في السكربت العلوي (العام)
window.loadCashierMain = function() {
    const lang = translations[currentLang];
    
    // بناء واجهة الكاشير (عرض الطلبات وزر الفاتورة الجديدة)
    let html = `
        <div class="admin-section">
            <div class="header-flex" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <span class="branch-tag" id="active-branch-name">${window.currentBranchName || 'جاري التحميل...'}</span>
                    <button class="btn-main" onclick="openNewInvoiceModal()" style="font-size:1.2rem; padding:12px 25px;">
                        <i class="fas fa-plus-circle"></i> فاتورة جديدة
                    </button>
                </div>
                <h3><i class="fas fa-cash-register"></i> نظام المبيعات</h3>
            </div>

            <div class="info-card" style="background: rgba(255,255,255,0.05); margin-bottom:20px;">
                <p style="margin:0; font-size:14px; color:#aaa;">قائمة الطلبات الأخيرة (من الأحدث إلى الأقدم)</p>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>رقم الفاتورة</th>
                        <th>العميل</th>
                        <th>التاريخ والوقت</th>
                        <th>الإجمالي</th>
                        <th>الدفع</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody id="recent-orders-list">
                    </tbody>
            </table>
        </div>`;

    document.getElementById('content-area').innerHTML = html;

    // تشغيل محرك جلب البيانات من الموديول
    if(window.renderRecentOrders) {
        window.renderRecentOrders();
    }
};



// دالة طباعة الفاتورة بالتنسيق المطلوب (مخبز ومطعم التين)
window.printThermalInvoice = function(order) {
    let printContent = `
        <div id="print-receipt-area">
            <img src="Logo.png" class="receipt-logo">
            <div class="receipt-header">
                <div style="width:48%">
                    <b>مخبز التين والزيتون</b><br>
                    <small>اليرموك، ق٢ شارع ٢<br>22085889 | 65162277</small>
                </div>
                <div style="width:48%; text-align:left;">
                    <b>مطعم التين الطبيعي</b><br>
                    <small>أبو الحصانية، مول ٣٠<br>22085886 | 99176512</small>
                </div>
            </div>
            <p style="text-align:center; font-size:10px;">@figsolives.kw | @natural_figs</p>
            <hr>
            <table style="width:100%; font-size:12px;">
                ${order.items.map(item => `
                    <tr><td>${item.nameAr} x ${item.qty}</td><td style="text-align:left;">${(item.qty * item.price).toFixed(3)}</td></tr>
                    ${item.note ? `<tr><td colspan="2" style="font-size:10px; color:#555;">- ${item.note}</td></tr>` : ''}
                `).join('')}
            </table>
            <hr>
            <p>الصافي: ${order.net} د.ك</p>
            <p>التوصيل: ${order.delivery} د.ك</p>
            ${order.discount > 0 ? `<p>الخصم: ${order.discount} د.ك</p>` : ''}
            <h3 style="text-align:center;">الإجمالي الكلي: ${order.total} د.ك</h3>
            <div class="footer-msg">صحتك أغلى ماتملك.. فتناول شيئاً صحياً</div>
        </div>`;
    
    const printDiv = document.createElement('div');
    printDiv.innerHTML = printContent;
    document.body.appendChild(printDiv);
    window.print();
    printDiv.remove();
};


// مصفوفة السلة (تكون فارغة عند فتح فاتورة جديدة)
window.currentBasket = [];



window.closeInvoiceModal = function() {
    const modal = document.getElementById('invoice-overlay');
    if(modal) modal.remove();
    window.currentBasket = []; // تصفير السلة عند الإغلاق
};




// 1. دالة إضافة الأرقام في مودال الكمية (الناقصة)
window.appendQty = function(val) {
    const input = document.getElementById('qty-input');
    if (val === 'clear') {
        input.value = input.value.slice(0, -1);
    } else {
        input.value += val;
    }
};

// 2. جسر لدالة البحث (الناقصة)
window.searchProduct = function() {
    const input = document.getElementById('cashier-search');
    window.handleCashierSearch({ key: 'Enter', target: input });
};

// 3. توحيد دالة معرف الجهاز
function checkDeviceBinding() {
    // توحيد المسمى إلى figs_pos_id ليتوافق مع الكاشير
    let deviceID = localStorage.getItem('figs_pos_id');
    if (!deviceID) {
        deviceID = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        localStorage.setItem('figs_pos_id', deviceID);
    }
    return deviceID;
}


// 1. تعريف مخزن البيانات (يجب أن يكون في بداية السكربت)
window.allOrdersData = {}; 

// 2. دالة تعبئة قوائم الفلترة (كانت مفقودة في كودك)
window.populateFilter = function(elementId, data, fieldName) {
    const select = document.getElementById(elementId);
    if (!select || !data) return;
    
    // مسح الخيارات القديمة مع الإبقاء على الخيار الأول (الكل)
    select.innerHTML = select.options[0].outerHTML; 
    
    for (let id in data) {
        const option = document.createElement('option');
        option.value = id;
        option.text = data[id][fieldName] || data[id].name || id;
        select.appendChild(option);
    }
};

// 3. دالة تحديد الكل في جدول الطلبات (مطلوبة لعمل التشيك بوكس)
window.toggleSelectAllOrders = function(source) {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
};

window.loadProductsPage = function() {
    const lang = translations[currentLang];
    
    // بناء واجهة إدارة المنتجات المتكاملة
    let html = `
        <div class="admin-section">
            <div class="header-flex" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3><i class="fas fa-box"></i> المنتجات</h3>
                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn-main" onclick="openAddProductModal()">
                        <i class="fas fa-plus-circle"></i> منتج جديد
                    </button>
                    <button class="btn-main" style="background:#27ae60;" onclick="exportProductsExcel()">
                        <i class="fas fa-file-excel"></i> تحميل التقرير
                    </button>
                    <button class="btn-main" style="background:#8e44ad;" onclick="downloadSelectedBarcodes()">
                        <i class="fas fa-barcode"></i> تحميل الباركودات
                    </button>
                    <button class="btn-main" style="background:#2980b9;" onclick="triggerBulkImport()">
                        <i class="fas fa-upload"></i> إضافة مجموعة
                    </button>
                    <button class="btn-clear" onclick="downloadProductTemplate()" style="font-size:12px; border:1px solid #444;">
                        <i class="fas fa-file-download"></i> نموذج الإكسل
                    </button>
                </div>
            </div>

            <div class="info-card" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:15px; background: rgba(255,255,255,0.05); margin-bottom:20px; padding:15px; border-radius:10px;">
                <div>
                    <label style="font-size:11px; color:#aaa; display:block; margin-bottom:5px;">فرز حسب الفرع</label>
                    <select id="filter-product-branch" onchange="refreshProductStock()" style="width:100%; padding:8px; background:#1a1a2e; color:white; border:1px solid #444; border-radius:5px;">
                        <option value="main">الفرع الرئيسي</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:11px; color:#aaa; display:block; margin-bottom:5px;">التصنيف</label>
                    <select id="filter-product-category" onchange="filterProductsTable()" style="width:100%; padding:8px; background:#1a1a2e; color:white; border:1px solid #444; border-radius:5px;">
                        <option value="">كل التصنيفات</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:11px; color:#aaa; display:block; margin-bottom:5px;">مكان التخزين</label>
                    <select id="filter-product-storage" onchange="filterProductsTable()" style="width:100%; padding:8px; background:#1a1a2e; color:white; border:1px solid #444; border-radius:5px;">
                        <option value="">كل أماكن التخزين</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:11px; color:#aaa; display:block; margin-bottom:5px;">المبيعات</label>
                    <select id="sort-product-sales" onchange="filterProductsTable()" style="width:100%; padding:8px; background:#1a1a2e; color:white; border:1px solid #444; border-radius:5px;">
                        <option value="none">بدون ترتيب</option>
                        <option value="high">الأعلى مبيعاً</option>
                        <option value="low">الأقل مبيعاً</option>
                    </select>
                </div>
            </div>

            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-products" onclick="toggleAllProducts(this)"></th>
                            <th>المنتج</th>
                            <th>التصنيف</th>
                            <th>التكلفة / البيع</th>
                            <th>المخزون (الوحدة)</th>
                            <th>الحالة</th>
                            <th>مرات البيع</th>
                            <th>الباركود</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="products-list-body">
                        </tbody>
                </table>
            </div>

            <div id="import-progress-container" style="display:none; margin: 25px auto; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 12px; max-width: 550px; border: 1px solid var(--gold-accent); box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="color:var(--gold-accent); font-weight:bold;">جاري معالجة الملف...</span>
                    <span id="import-percent-text" style="color:white;">0%</span>
                </div>
                <progress id="import-progress-bar" value="0" max="100" style="width:100%; height: 12px; border-radius: 10px; accent-color: var(--gold-accent);"></progress>
                <p id="import-status-text" style="text-align:center; font-size:13px; margin-top: 10px; color: #ccc;"></p>
            </div>
        </div>`;

    document.getElementById('content-area').innerHTML = html;

    // تشغيل محرك الربط مع قاعدة البيانات
    if (window.initProductsLogic) {
        window.initProductsLogic();
    }
};

// استبدل دالة openAddProductModal بهذا الكود المحدث
window.openAddProductModal = function() {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box" style="width:600px;">
                <h3>إضافة منتج جديد</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input type="text" id="p-name-ar" placeholder="الاسم العربي">
                    <input type="text" id="p-name-en" placeholder="الاسم الإنجليزي">
                    <input type="number" id="p-cost" placeholder="التكلفة">
                    <input type="number" id="p-price" placeholder="سعر البيع">
                    <select id="p-unit-select"><option>جاري تحميل الوحدات...</option></select>
                    <input type="number" id="p-reorder" placeholder="نقطة إعادة الطلب">
                    <input type="number" id="p-initial-stock" placeholder="المخزون الأولي (الفرع الرئيسي)">
                    <div style="grid-column: span 1;">
                        <input type="text" id="p-barcode" placeholder="رقم الباركود (اختياري)">
                    </div>
                </div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveNewProduct()">إضافة المنتج</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    populateUnitsDropdown();
};

window.downloadProductTemplate = function() {
    // تجهيز رؤوس الأعمدة المطلوبة لمخبز التين والزيتون
    const data = [[
        "الاسم العربي", "الاسم الإنجليزي", "التكلفة", "سعر البيع", 
        "الوحدة", "المخزون الأولي", "نقطة إعادة الطلب", "الباركود (اختياري)"
    ]];
    
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Products Template");
    
    // تحميل الملف
    XLSX.writeFile(workbook, "Figs_Olives_Products_Template.xlsx");
};

// دالة فتح نافذة اختيار ملف الإكسل
window.triggerBulkImport = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx, .xls';
    input.onchange = (e) => {
        if (window.handleBulkProductImport) {
            window.handleBulkProductImport(e);
        }
    };
    input.click();
};

// دالة تحديث واجهة العداد (Progress UI)
window.updateImportProgress = function(current, total) {
    const container = document.getElementById('import-progress-container');
    const bar = document.getElementById('import-progress-bar');
    const text = document.getElementById('import-status-text');
    
    container.style.display = 'block';
    const percent = Math.round((current / total) * 100);
    bar.value = percent;
    text.innerText = `جاري رفع المنتجات: (${current} من ${total}) - اكتمل ${percent}%`;
    
    if (current === total) {
        setTimeout(() => {
            container.style.display = 'none';
            alert("✅ تم استيراد جميع المنتجات بنجاح");
        }, 1500);
    }
};

// 1. دالة جلب الوحدات المضافة مسبقاً لوضعها في قائمة المنتج
window.populateUnitsDropdown = function() {
    const select = document.getElementById('p-unit-select');
    if (!select) return;
    
    // جلب البيانات من مصفوفة الوحدات العالمية التي سنعرفها في الموديول
    if (window.availableUnits) {
        select.innerHTML = '<option value="">-- اختر الوحدة --</option>';
        for (let id in window.availableUnits) {
            const unit = window.availableUnits[id];
            select.innerHTML += `<option value="${unit.nameAr}">${unit.nameAr}</option>`;
        }
    } else {
        select.innerHTML = '<option>لا توجد وحدات مضافة</option>';
    }
};

// 2. دالة حفظ المنتج الجديد
window.saveNewProduct = function() {
    const nameAr = document.getElementById('p-name-ar').value;
    const nameEn = document.getElementById('p-name-en').value;
    const cost = document.getElementById('p-cost').value;
    const price = document.getElementById('p-price').value;
    const unit = document.getElementById('p-unit-select').value;
    const reorder = document.getElementById('p-reorder').value;
    const stock = document.getElementById('p-initial-stock').value; // جلب قيمة المخزون الأولي
    let barcode = document.getElementById('p-barcode').value;

    // التحقق من البيانات الأساسية
    if (!nameAr || !price || !unit) {
        const errorMsg = currentLang === 'ar' 
            ? "يرجى إكمال الحقول الأساسية: الاسم، سعر البيع، والوحدة" 
            : "Please complete essential fields: Name, Price, and Unit";
        alert(errorMsg);
        return;
    }

    // توليد باركود آلي إذا كان الحقل فارغاً
    if (!barcode) {
        barcode = "FIGS" + Date.now().toString().slice(-8);
    }

    const productData = {
        nameAr,
        nameEn,
        cost: parseFloat(cost) || 0,
        price: parseFloat(price) || 0,
        unit,
        reorderPoint: parseFloat(reorder) || 5,
        barcode,
        stock: parseFloat(stock) || 0, // تم التعديل ليأخذ القيمة المدخلة بدلاً من 0
        salesCount: 0,
        createdAt: new Date().toISOString()
    };

    // إرسال البيانات للمحرك في الموديول (Firebase)
    if (window.addProductToFirebase) {
        window.addProductToFirebase(productData);
    } else {
        console.error("محرك قاعدة البيانات غير متصل");
    }
};

// 1. دالة بناء صفحة الوحدات
window.loadUnitsPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-balance-scale"></i> إدارة الوحدات</h3>
                <button class="btn-main" onclick="openAddUnitModal()">+ وحدة جديدة</button>
            </div>
            <div class="info-card" style="margin-top:10px;">
                <i class="fas fa-info-circle"></i> اضغط على اسم الوحدة لعرض كافة المنتجات المرتبطة بها.
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>الاسم العربي</th>
                        <th>الاسم الإنجليزي</th>
                        <th>عدد المنتجات المرتبطة</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody id="units-list-body">
                    </tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    if(window.initUnitsLogic) window.initUnitsLogic();
};

// 2. دالة فتح نافذة إضافة وحدة جديدة
window.openAddUnitModal = function() {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>إضافة وحدة قياس جديدة</h3>
                <input type="text" id="u-name-ar" placeholder="الاسم العربي (مثل: حبة، كيلو، كرتون)">
                <input type="text" id="u-name-en" placeholder="English Name (e.g., Piece, KG, Box)">
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveNewUnit()">إضافة الوحدة</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// 3. دالة جمع البيانات وإرسالها للموديول
window.saveNewUnit = function() {
    const nameAr = document.getElementById('u-name-ar').value;
    const nameEn = document.getElementById('u-name-en').value;

    if (!nameAr || !nameEn) {
        alert("يرجى إدخال الاسمين العربي والإنجليزي للوحدة");
        return;
    }

    if (window.addUnitToFirebase) {
        window.addUnitToFirebase({ nameAr, nameEn });
    }
};

// أضف هذه الدالة داخل السكربت الأول لكي تعمل القوائم الجانبية
window.toggleDropdown = function(id) {
    const dropdown = document.getElementById(id);
    if (dropdown) {
        dropdown.classList.toggle('show');
        
        // إغلاق باقي القوائم المفتوحة ليكون الشكل أرتب (اختياري)
        document.querySelectorAll('.dropdown-container').forEach(el => {
            if (el.id !== id) el.classList.remove('show');
        });
    }
};


// 1. دالة فتح نافذة التعديل ببيانات المنتج الحالية
window.editProduct = async function(id) {
    const snap = await get(ref(database, 'products/' + id));
    const p = snap.val();
    if (!p) return;

    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box" style="width:600px;">
                <h3>تعديل منتج: ${p.nameAr}</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input type="text" id="edit-p-name-ar" value="${p.nameAr}" placeholder="الاسم العربي">
                    <input type="text" id="edit-p-name-en" value="${p.nameEn || ''}" placeholder="الاسم الإنجليزي">
                    <input type="number" id="edit-p-cost" value="${p.cost}" placeholder="التكلفة">
                    <input type="number" id="edit-p-price" value="${p.price}" placeholder="سعر البيع">
                    <select id="edit-p-unit-select"></select>
                    <input type="number" id="edit-p-reorder" value="${p.reorderPoint}" placeholder="نقطة إعادة الطلب">
                    <input type="number" id="edit-p-stock" value="${p.stock}" placeholder="المخزون الحالي">
                    <input type="text" id="edit-p-barcode" value="${p.barcode}" placeholder="الباركود">
                </div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveProductUpdate('${id}')">حفظ التغييرات</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ملء قائمة الوحدات وتحديد الوحدة الحالية
    const unitSelect = document.getElementById('edit-p-unit-select');
    for (let uid in window.availableUnits) {
        const unit = window.availableUnits[uid];
        const selected = unit.nameAr === p.unit ? 'selected' : '';
        unitSelect.innerHTML += `<option value="${unit.nameAr}" ${selected}>${unit.nameAr}</option>`;
    }
};

// 2. دالة جمع البيانات المحدثة وإرسالها للموديول
window.saveProductUpdate = function(id) {
    const data = {
        nameAr: document.getElementById('edit-p-name-ar').value,
        nameEn: document.getElementById('edit-p-name-en').value,
        cost: parseFloat(document.getElementById('edit-p-cost').value) || 0,
        price: parseFloat(document.getElementById('edit-p-price').value) || 0,
        unit: document.getElementById('edit-p-unit-select').value,
        reorderPoint: parseFloat(document.getElementById('edit-p-reorder').value) || 0,
        stock: parseFloat(document.getElementById('edit-p-stock').value) || 0,
        barcode: document.getElementById('edit-p-barcode').value
    };

    if (window.updateProductInFirebase) {
        window.updateProductInFirebase(id, data);
    }
};

// 3. دالة حذف المنتج
window.confirmDeleteProduct = function(id) {
    if (confirm("هل أنت متأكد من حذف هذا المنتج نهائياً؟ سيتم حذفه أيضاً من المخازن.")) {
        if (window.deleteProductFromFirebase) {
            window.deleteProductFromFirebase(id);
        }
    }
};

// متغيرات لتتبع المسار الحالي للتنقل
window.categoryPath = []; 

window.loadCategoriesPage = function() {
    const lang = translations[currentLang];
    const currentId = window.categoryPath.length > 0 ? window.categoryPath[window.categoryPath.length - 1].id : null;
    const currentName = window.categoryPath.length > 0 ? window.categoryPath[window.categoryPath.length - 1].name : "الأقسام الرئيسية";

    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-tags"></i> ${currentName}</h3>
                <div style="display:flex; gap:10px;">
                    ${window.categoryPath.length > 0 ? `<button class="btn-clear" onclick="goBackCategory()"><i class="fas fa-arrow-right"></i> رجوع</button>` : ''}
                    <button class="btn-main" onclick="openAddCategoryModal('${currentId}')">+ قسم ${currentId ? 'فرعي' : 'جديد'}</button>
                    ${currentId ? `<button class="btn-main" style="background:#27ae60;" onclick="openAddProductToCategoryModal('${currentId}')">+ إضافة منتجات</button>` : ''}
                </div>
            </div>

            <div class="info-card" style="margin:15px 0;">
                <input type="text" id="cat-search" placeholder="بحث في الأقسام والمنتجات..." oninput="filterCategoriesAndProducts()" style="width:100%; padding:10px; background:#1a1a2e; color:white; border:1px solid #444; border-radius:8px;">
            </div>

            <div id="categories-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px;">
                </div>
        </div>`;
    
    document.getElementById('content-area').innerHTML = html;
    if(window.initCategoriesLogic) window.initCategoriesLogic(currentId);
};

// دالة فتح مودال إضافة قسم
window.openAddCategoryModal = function(parentId) {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>إضافة قسم ${parentId !== 'null' ? 'فرعي' : 'رئيسي'}</h3>
                <input type="text" id="cat-name-ar" placeholder="اسم القسم بالعربي">
                <input type="text" id="cat-name-en" placeholder="English Category Name">
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveCategory('${parentId}')">إضافة</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// دالة الرجوع للخلف
window.goBackCategory = function() {
    window.categoryPath.pop();
    loadCategoriesPage();
};


// دالة بناء صفحة مواد المخزون
window.loadInventoryItemsPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-warehouse"></i> مواد المخزون</h3>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn-main" onclick="openAddInvItemModal()">+ مادة جديدة</button>
                    <button class="btn-main" style="background:#27ae60;" onclick="exportInvItemsExcel()"><i class="fas fa-file-excel"></i> تقرير</button>
                    <button class="btn-main" style="background:#8e44ad;" onclick="downloadInvBarcodesZIP()"><i class="fas fa-file-archive"></i> تحميل الباركودات</button>
                    <button class="btn-main" style="background:#2980b9;" onclick="triggerBulkInvImport()"><i class="fas fa-upload"></i> إضافة مجموعة</button>
                    <button class="btn-clear" onclick="downloadInvItemTemplate()" style="font-size:11px; border:1px solid #444;"><i class="fas fa-download"></i> النموذج</button>
                </div>
            </div>

            <div class="info-card" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; background: rgba(255,255,255,0.05); margin:15px 0; padding:15px; border-radius:10px;">
                <select id="inv-filter-branch" onchange="initInventoryItemsLogic()"><option value="main">الفرع الرئيسي</option></select>
                <select id="inv-filter-storage" onchange="filterInvTable()"><option value="">كل أماكن التخزين</option></select>
                <select id="inv-sort-sales" onchange="filterInvTable()">
                    <option value="none">ترتيب المبيعات</option>
                    <option value="high">الأعلى</option>
                    <option value="low">الأقل</option>
                </select>
            </div>

            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-inv" onclick="toggleAllInvItems(this)"></th>
                            <th>المادة</th>
                            <th>التكلفة</th>
                            <th>المخزون (الوحدة)</th>
                            <th>الحالة</th>
                            <th>مكان التخزين</th>
                            <th>مُعرف الإنتاج</th>
                            <th>غير مُعرف</th>
                            <th>مرات البيع</th>
                            <th>الباركود</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="inv-items-list-body"></tbody>
                </table>
            </div>

            <div id="inv-import-progress" style="display:none; margin-top:20px; padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; border:1px solid var(--gold-accent);">
                <progress id="inv-progress-bar" value="0" max="100" style="width:100%; height:15px;"></progress>
                <p id="inv-progress-text" style="text-align:center; font-size:12px; margin-top:10px; color:var(--gold-accent);"></p>
            </div>
        </div>`;
    
    document.getElementById('content-area').innerHTML = html;
    if(window.initInventoryItemsLogic) window.initInventoryItemsLogic();
};

// تحميل نموذج الإكسل لمواد المخزون
window.downloadInvItemTemplate = function() {
    const data = [["الاسم العربي", "الاسم الإنجليزي", "التكلفة", "الوحدة", "المخزون الأولي", "نقطة إعادة الطلب", "الباركود"]];
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Inventory Template");
    XLSX.writeFile(workbook, "Figs_Olives_Inventory_Template.xlsx");
};

// تجميع الباركودات في ملف مضغوط
window.downloadInvBarcodesZIP = async function() {
    const selected = document.querySelectorAll('.inv-checkbox:checked');
    if (selected.length === 0) return alert("حدد مواد أولاً");
    const zip = new JSZip();
    selected.forEach(cb => {
        const id = cb.dataset.id;
        const name = cb.dataset.name;
        const canvas = document.getElementById(`inv-bc-${id}`);
        if(canvas) {
            const imgData = canvas.toDataURL("image/png").split(',')[1];
            zip.file(`${name}.png`, imgData, {base64: true});
        }
    });
    const content = await zip.generateAsync({type:"blob"});
    saveAs(content, `Inv_Barcodes_${Date.now()}.zip`);
};


// 1. فتح نافذة إضافة مادة مخزون جديدة
window.openAddInvItemModal = function() {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box" style="width:600px;">
                <h3>إضافة مادة مخزون جديدة</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <input type="text" id="inv-name-ar" placeholder="الاسم العربي">
                    <input type="text" id="inv-name-en" placeholder="الاسم الإنجليزي">
                    <input type="number" id="inv-cost" placeholder="التكلفة">
                    <select id="inv-unit-select"></select>
                    <input type="number" id="inv-stock" placeholder="المخزون الأولي">
                    <input type="number" id="inv-reorder" placeholder="نقطة إعادة الطلب">
                    <div style="grid-column: span 2;">
                        <input type="text" id="inv-barcode" placeholder="الباركود (اتركه فارغاً للتوليد آلياً)">
                    </div>
                </div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveNewInvItem()">إضافة المادة</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // تعبئة الوحدات في القائمة المنسدلة
    const select = document.getElementById('inv-unit-select');
    if (window.availableUnits) {
        for (let id in window.availableUnits) {
            const u = window.availableUnits[id];
            select.innerHTML += `<option value="${u.nameAr}">${u.nameAr}</option>`;
        }
    }
};

// 2. تفعيل اختيار الكل في الجدول
window.toggleAllInvItems = function(source) {
    const checkboxes = document.querySelectorAll('.inv-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
};

// 3. تشغيل نافذة اختيار ملف الإكسل
window.triggerBulkInvImport = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.xlsx, .xls';
    input.onchange = (e) => {
        if (window.handleBulkInvProductImport) {
            window.handleBulkInvProductImport(e);
        }
    };
    input.click();
};

    </script>

    <script type="module">
    import { database, ref, onValue, set, get, update } from './firebase-config.js?v=2';
window.set = set;
window.ref = ref;
window.database = database;
window.get = get;
window.update = update;

    // 1. مراقب الفروع العام (يعمل فوراً لضمان جاهزية قائمة الربط)
    onValue(ref(database, 'branches'), (snapshot) => {
        window.availableBranches = snapshot.val();
        console.log("قاعدة بيانات الفروع جاهزة");
    });

    window.initDevicesAndCashiers = function() {
    const lang = translations[currentLang]; // جلب اللغة الحالية

    // استبدل الجزء الخاص بمراقبة الأجهزة داخل initDevicesAndCashiers بهذا
onValue(ref(database, 'authorized_devices'), (snapshot) => {
    const tbody = document.getElementById('devices-live-list');
    if (!tbody) return;
    tbody.innerHTML = "";
    const data = snapshot.val();
    
    for (let id in data) { // id هنا هو المفتاح الحقيقي في Firebase
        const d = data[id];
        const branchDisplayName = d.branchName && d.branchName !== "غير محدد" 
            ? d.branchName 
            : (currentLang === 'ar' ? 'غير محدد' : 'Not Assigned');

        const activationStatus = d.active 
            ? `<span style="color:#28a745">مفعل ✅</span>` 
            : `<span style="color:#e94560">غير مفعل ❌</span>`;

        tbody.innerHTML += `
            <tr>
                <td style="font-family: monospace; font-size: 12px;">${id}</td>
                <td>${activationStatus}</td>
                <td>${branchDisplayName}</td>
                <td style="font-size: 11px;">${d.lastSeen || '-'}</td>
                <td>
                    <button class="btn-main link-device-btn" 
                            data-id="${id}" 
                            data-name="${d.branchName || ''}">
                        ${translations[currentLang].link}
                    </button>
                </td>
            </tr>`;
    }
});

    // 2. مراقبة الكاشير (Cashiers)
    onValue(ref(database, 'cashiers'), (snapshot) => {
        const tbody = document.getElementById('cashiers-list-body'); 
        if (!tbody) return;
        tbody.innerHTML = "";
        const data = snapshot.val();

        if (!data) {
            const noDataMsg = currentLang === 'ar' ? 'لا يوجد كاشير مضاف' : 'No cashiers added';
            tbody.innerHTML = `<tr><td colspan="3">${noDataMsg}</td></tr>`;
            return;
        }

        for (let pin in data) {
            const c = data[pin];
            tbody.innerHTML += `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.pin}</td>
                    <td>
                        <button class="btn-main edit-cashier-btn" 
                                data-pin="${c.pin}" 
                                data-name="${c.name}">
                            ${lang.edit}
                        </button> 
                        <button class="btn-clear delete-cashier-btn" 
                                data-pin="${c.pin}">
                            ${lang.delete}
                        </button>
                    </td>
                </tr>`;
        }
    });
};

    window.initUsersLogic = function() {
    onValue(ref(database, 'system_users'), (snapshot) => {
        const tbody = document.getElementById('users-list-body');
        if (!tbody) return;
        tbody.innerHTML = "";

        // 1. استدعاء اللغة الحالية من القاموس
        const lang = translations[currentLang]; 

        const data = snapshot.val();
        for (let pin in data) {
            const u = data[pin];
            tbody.innerHTML += `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.role}</td>
                    <td>${u.pin}</td>
                    <td>
                        <button class="btn-main edit-user-btn" 
                                data-pin="${u.pin}" 
                                data-name="${u.name}" 
                                data-role="${u.role}">
                            ${lang.edit}
                        </button> 
                        
                        <button class="btn-clear delete-user-btn" 
                                data-pin="${u.pin}">
                            ${lang.delete}
                        </button>
                    </td>
                </tr>`;
        }
    });
};

    window.listenToBranches = function() {
    onValue(ref(database, 'branches'), (snapshot) => {
        const tbody = document.getElementById('branches-list-body');
        if (!tbody) return;
        tbody.innerHTML = "";

        const lang = translations[currentLang]; 

        const data = snapshot.val();
        if (!data) { 
            tbody.innerHTML = `<tr><td colspan='4'>${currentLang === 'ar' ? 'لا توجد فروع مضافة' : 'No branches added'}</td></tr>`; 
            return; 
        }

        for (let id in data) {
            const b = data[id];
            // تحديد النص بناءً على نوع الفرع واللغة
            const branchType = b.isMain 
                ? (currentLang === 'ar' ? 'رئيسي ★' : 'Main ★') 
                : (currentLang === 'ar' ? 'فرعي' : 'Sub-Branch');

            tbody.innerHTML += `
                <tr>
                    <td>${b.nameAr}</td>
                    <td>${b.nameEn}</td>
                    <td>${branchType}</td>
                    <td>
                        <button class="btn-main edit-branch-btn" 
                                data-id="${id}" 
                                data-ar="${b.nameAr}" 
                                data-en="${b.nameEn}" 
                                data-main="${b.isMain}">
                            ${lang.edit}
                        </button>
                        <button class="btn-clear delete-branch-btn" 
                                data-id="${id}">
                            ${lang.delete}
                        </button>
                    </td>
                </tr>`;
        }
    });
};

    // 3. محرك تسجيل الدخول (فحص الرموز من 4 أرقام)
    window.verifyUserLogin = async function(enteredPin) {
        const errorMsg = document.getElementById('login-error');
        if (enteredPin === "123456") { // رمز الطوارئ
            sessionStorage.setItem('userRole', 'admin');
            sessionStorage.setItem('userName', 'المدير العام');
            location.reload(); return;
        }
        try {
            const userSnap = await get(ref(database, 'system_users/' + enteredPin));
            if (userSnap.exists()) {
                const u = userSnap.val();
                sessionStorage.setItem('userRole', u.role);
                sessionStorage.setItem('userName', u.name);
                location.reload(); return;
            }
            errorMsg.style.display = "block";
        } catch (e) { alert("خطأ في الاتصال"); }
    };

    // 4. وظائف الحفظ (المستخدمين والكاشير والفروع)
    window.confirmSaveUser = async function() {
        const name = document.getElementById('user-name-input').value;
        const role = document.getElementById('user-role-select').value;
        const pin = document.getElementById('user-pin-input').value;
        if (!name || !pin) return alert("يرجى إكمال البيانات");
        await set(ref(database, 'system_users/' + pin), { name, role, pin, createdAt: new Date().toISOString() });
        closeModal();
    };

    window.saveNewCashier = async function() {
        const name = document.getElementById('cashier-name-input').value;
        const pin = document.getElementById('cashier-pin-input').value;
        if (!name || !pin) return alert("يرجى إكمال بيانات الكاشير");
        await set(ref(database, 'cashiers/' + pin), { name, pin, createdAt: new Date().toISOString() });
        closeModal();
    };

    // محرك صيد النقرات المطور لإصلاح أزرار التعديل والحذف
    document.addEventListener('click', async (e) => {
    const t = e.target;
    // استدعاء قاموس اللغة الحالية لتسهيل الاستخدام
    const lang = translations[currentLang];

    // تعديل منطقة توصيل
    if (t.closest('.edit-area-btn')) {
        const btn = t.closest('.edit-area-btn');
        window.openEditAreaModal(btn.dataset.id, btn.dataset.ar, btn.dataset.en, btn.dataset.price);
    }

    // حذف منطقة توصيل
    if (t.closest('.delete-area-btn')) {
        const btn = t.closest('.delete-area-btn');
        if (confirm(lang.deleteConfirm)) {
            await set(ref(database, 'delivery_areas/' + btn.dataset.id), null);
        }
    }

    // 1. تعديل مستخدم (المحاسبة)
    if (t.closest('.edit-user-btn')) {
        const btn = t.closest('.edit-user-btn');
        window.openEditUserModal(btn.dataset.pin, btn.dataset.name, btn.dataset.role);
    }

    // 2. تعديل كاشير (المبيعات)
    if (t.closest('.edit-cashier-btn')) {
        const btn = t.closest('.edit-cashier-btn');
        window.openEditCashierModal(btn.dataset.pin, btn.dataset.name);
    }

    // 3. حذف كاشير (استخدام الترجمة في رسالة التأكيد)
    if (t.closest('.delete-cashier-btn')) {
        const btn = t.closest('.delete-cashier-btn');
        // استخدام المفتاح deleteConfirm من القاموس
        if (confirm(lang.deleteConfirm)) { 
            await set(ref(database, 'cashiers/' + btn.dataset.pin), null);
        }
    }

    // 4. حذف مستخدم (استخدام الترجمة في رسالة التأكيد)
    if (t.closest('.delete-user-btn')) {
        const btn = t.closest('.delete-user-btn');
        if (confirm(lang.deleteConfirm)) { 
            await set(ref(database, 'system_users/' + btn.dataset.pin), null);
        }
    }

    // 5. ربط جهاز
    if (t.closest('.link-device-btn')) {
        const btn = t.closest('.link-device-btn');
        window.openEditDeviceModal(btn.dataset.id, btn.dataset.name);
    }
    
    // 6. تعديل فرع وحذفه (استخدام الترجمة في رسالة التأكيد)
    if (t.closest('.edit-branch-btn')) {
        const btn = t.closest('.edit-branch-btn');
        window.openEditBranchModal(btn.dataset.id, btn.dataset.ar, btn.dataset.en, btn.dataset.main);
    }
    if (t.closest('.delete-branch-btn')) {
        const btn = t.closest('.delete-branch-btn');
        if (confirm(lang.deleteConfirm)) { 
            await set(ref(database, 'branches/' + btn.dataset.id), null);
        }
    }

// أضف هذه داخل document.addEventListener('click')
if (t.closest('.edit-price-btn')) {
    const btn = t.closest('.edit-price-btn');
    window.openEditPriceModal(btn.dataset.id, btn.dataset.price, JSON.parse(btn.dataset.areas));
}

if (t.closest('.delete-price-btn')) {
    const btn = t.closest('.delete-price-btn');
    if (confirm(lang.deleteConfirm)) {
        await set(ref(database, 'delivery_prices/' + btn.dataset.id), null);
    }
}

});

    // 6. الصلاحيات وفحص الجهاز
    window.applyRolePermissions = function(role) {
        document.querySelectorAll('.sidebar-item, .dropdown-btn').forEach(el => el.style.setProperty('display', 'block', 'important'));
        const hidden = { 'أمين صندوق': ['#drop-stores', '#drop-suppliers'], 'أمين مخازن': ['#drop-admin'] };
        if (hidden[role]) hidden[role].forEach(s => document.querySelectorAll(s).forEach(el => el.style.setProperty('display', 'none', 'important')));
    };

    // البحث عن السطر الذي يبدأ بـ let deviceID = localStorage.getItem...
const role = sessionStorage.getItem('userRole');
if (role) {
    window.applyRolePermissions(role);
    let deviceID = checkDeviceBinding(); // استخدام الدالة الموحدة
    update(ref(database, 'authorized_devices/' + deviceID), { 
        id: deviceID,
        status: 'online', 
        lastSeen: new Date().toLocaleString() 
    });
}


onValue(ref(database, 'products'), (snapshot) => {
    const products = snapshot.val() || {};
    // تصفية المنتجات التي وصلت أو قلّت عن نقطة إعادة الطلب
    const lowStockItems = Object.values(products).filter(p => parseFloat(p.stock) <= parseFloat(p.reorderPoint));
    
    // التحقق من أن المستخدم هو "أمين مخازن" لإظهار التنبيه
    if (lowStockItems.length > 0 && sessionStorage.getItem('userRole') === 'أمين مخازن') {
        const notifyHtml = `
            <div id="stock-alert-banner" style="background:#e94560; color:white; padding:12px; text-align:center; font-weight:bold; position:sticky; top:0; z-index:1000; border-bottom:2px solid rgba(0,0,0,0.2);">
                <i class="fas fa-exclamation-triangle"></i> تنبيه للمخازن: يوجد عدد (${lowStockItems.length}) منتجات وصلت لنقطة إعادة الطلب! يرجى مراجعة الجدول باللون الأحمر.
            </div>`;
        
        // إزالة التنبيه القديم إن وجد وإضافة الجديد
        document.getElementById('stock-alert-banner')?.remove();
        document.querySelector('.main-content').insertAdjacentHTML('afterbegin', notifyHtml);
    } else {
        // إخفاء التنبيه إذا تم تعديل الكميات وأصبح المخزون كافياً
        document.getElementById('stock-alert-banner')?.remove();
    }
});


     // دالة التحديث الفعلي للمستخدم في Firebase
    window.updateUserInFirebase = async function(pin, name, role) {
        try {
            await update(ref(database, 'system_users/' + pin), { name, role });
            alert("✅ تم تحديث بيانات المستخدم بنجاح");
            closeModal();
        } catch (e) { alert("خطأ في التحديث: " + e.message); }
    };

    // دالة التحديث الفعلي للكاشير في Firebase
    window.updateCashierInFirebase = async function(pin, name) {
        try {
            await update(ref(database, 'cashiers/' + pin), { name });
            alert("✅ تم تحديث بيانات الكاشير بنجاح");
            closeModal();
        } catch (e) { alert("خطأ في التحديث: " + e.message); }
    };


// --- دالة عرض البيانات الموحدة والمترجمة ---
window.initDeliveryAreasLogic = function() {
    const lang = translations[currentLang];
    
    // 1. جلب بيانات الزبائن وأسعار التوصيل معاً لضمان دقة الربط
    Promise.all([
        get(ref(database, 'customers')),
        get(ref(database, 'delivery_prices'))
    ]).then(([custSnap, priceSnap]) => {
        const allCustomers = custSnap.val() || {};
        const allPrices = priceSnap.val() || {};
        
        onValue(ref(database, 'delivery_areas'), (snapshot) => {
            const tbody = document.getElementById('delivery-areas-list');
            if (!tbody) return;
            tbody.innerHTML = "";
            const areas = snapshot.val() || {};

            for (let areaId in areas) {
                const area = areas[areaId];
                
                // 2. البحث عن السعر المرتبط بهذه المنطقة في قاعدة البيانات
                let assignedPrice = (currentLang === 'ar' ? "غير معرف" : "Undefined");
                let priceColor = "#e94560"; // لون أحمر للتنبيه إذا كان غير معرف

                for (let pId in allPrices) {
                    if (allPrices[pId].areaIds && allPrices[pId].areaIds.includes(areaId)) {
                        assignedPrice = parseFloat(allPrices[pId].price).toFixed(3) + " KD";
                        priceColor = "#28a745"; // لون أخضر إذا كان معرفاً
                        break;
                    }
                }

                // 3. حساب عدد الزبائن المندرجين تحت هذه المنطقة
                const count = Object.values(allCustomers).filter(c => c.areaId === areaId).length;

                tbody.innerHTML += `
                    <tr>
                        <td>${area.nameAr}</td>
                        <td>${area.nameEn}</td>
                        <td style="font-weight:bold; color:${priceColor};">
                            ${assignedPrice}
                        </td>
                        <td style="font-weight:bold; color:#f39c12; cursor:pointer" onclick="viewAreaCustomers('${areaId}')">
                            ${count} <i class="fas fa-users" style="font-size:12px; margin-right:5px;"></i>
                        </td>
                        <td>
                            <div style="display:flex; gap:5px; justify-content:center;">
                                <button class="btn-main edit-area-btn" 
                                        data-id="${areaId}" data-ar="${area.nameAr}" data-en="${area.nameEn}">
                                    ${lang.edit}
                                </button>
                                <button class="btn-clear delete-area-btn" data-id="${areaId}">
                                    ${lang.delete}
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }
        });
    });
};

// وظيفة الانتقال لصفحة العملاء مع فلتر
window.confirmSaveArea = async function() {
    // 1. جلب الأسماء فقط (حذفنا سطر جلب السعر)
    const nameAr = document.getElementById('area-name-ar').value;
    const nameEn = document.getElementById('area-name-en').value;

    // 2. التحقق من إدخال الأسماء
    if(!nameAr || !nameEn) {
        alert(currentLang === 'ar' ? "يرجى إكمال أسماء المنطقة" : "Please complete area names");
        return;
    }
    
    const id = Date.now();

    // 3. الحفظ في Firebase (لاحظ حذفنا المتغير price من هنا)
    try {
        await set(ref(database, 'delivery_areas/' + id), { 
            nameAr: nameAr, 
            nameEn: nameEn 
        });
        
        alert(translations[currentLang].saveSuccess);
        closeModal();
    } catch (e) {
        alert("Error: " + e.message);
    }
};


window.updateAreaInFirebase = async function(id, nameAr, nameEn) {
    try {
        // تحديث الاسم العربي والإنجليزي فقط في قاعدة البيانات
        await update(ref(database, 'delivery_areas/' + id), { 
            nameAr: nameAr, 
            nameEn: nameEn 
        });
        
        alert(translations[currentLang].saveSuccess);
        closeModal();
    } catch (e) {
        console.error("Error updating area:", e);
        alert("Error: " + e.message);
    }
};

window.updatePriceInFirebase = async function(id, price, areaIds) {
    try {
        await update(ref(database, 'delivery_prices/' + id), {
            price: price,
            areaIds: areaIds
        });
        alert(translations[currentLang].saveSuccess);
        closeModal();
    } catch (e) {
        console.error("Error updating price:", e);
        alert("Error: " + e.message);
    }
};

window.initDeliveryPricesLogic = function() {
    const lang = translations[currentLang];
    // جلب أسماء المناطق أولاً
    get(ref(database, 'delivery_areas')).then((areaSnap) => {
        const areasData = areaSnap.val() || {};

        onValue(ref(database, 'delivery_prices'), (snapshot) => {
            const tbody = document.getElementById('delivery-prices-list');
            if (!tbody) return;
            tbody.innerHTML = "";
            const prices = snapshot.val() || {};

            for (let id in prices) {
                const item = prices[id];
                // تحويل مصفوفة الـ IDs لأسماء مفهومة
                const areaNames = item.areaIds.map(aId => 
                    areasData[aId] ? (currentLang === 'ar' ? areasData[aId].nameAr : areasData[aId].nameEn) : ''
                ).filter(n => n !== '').join(' - ');

                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:bold; color:#28a745;">${parseFloat(item.price).toFixed(3)} KD</td>
                        <td style="font-size:12px; color:#aaa;">${areaNames}</td>
                        <td>
                            <button class="btn-main edit-price-btn" 
                                    data-id="${id}" 
                                    data-price="${item.price}" 
                                    data-areas='${JSON.stringify(item.areaIds)}'>
                                ${lang.edit}
                            </button>
                            <button class="btn-clear delete-price-btn" data-id="${id}">${lang.delete}</button>
                        </td>
                    </tr>`;
            }
        });
    });
};

window.triggerExcelUpload = () => document.getElementById('excel-upload').click();

window.handleExcelImport = async function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    const statusDiv = document.getElementById('import-status');
    const lang = translations[currentLang];

    reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        // جلب المناطق الحالية للفحص
        const existingSnap = await get(ref(database, 'delivery_areas'));
        const existingAreas = existingSnap.val() || {};
        const existingNames = Object.values(existingAreas).map(a => a.nameAr.trim());

        let addedCount = 0;
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const nameAr = row['الاسم بالعربي'] || row['Name Ar'];
            const nameEn = row['الاسم بالانجليزي'] || row['Name En'];

            if (nameAr && !existingNames.includes(nameAr.trim())) {
                const id = Date.now() + i;
                await set(ref(database, 'delivery_areas/' + id), { nameAr, nameEn });
                addedCount++;
            }
            statusDiv.innerText = lang.importProgress.replace('{count}', i + 1).replace('{total}', rows.length);
        }
        alert(lang.saveSuccess + " - " + lang.duplicateSkip);
        statusDiv.innerText = "";
    };
    reader.readAsArrayBuffer(file);
};

window.downloadExcelTemplate = function() {
    // 1. تجهيز البيانات (رؤوس الأعمدة)
    const data = [["الاسم بالعربي", "الاسم بالانجليزي"]];
    
    // 2. تحويل البيانات إلى "شيت" (Worksheet)
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    
    // 3. إنشاء كتاب عمل جديد (Workbook)
    const workbook = XLSX.utils.book_new();
    
    // 4. إضافة الشيت إلى كتاب العمل
    XLSX.utils.book_append_sheet(workbook, worksheet, "Template");
    
    // 5. الأمر الصحيح لتحميل الملف (بدون كلمة utils)
    XLSX.writeFile(workbook, "Delivery_Areas_Template.xlsx");
};

window.initCustomersLogic = async function() {
    const ordersSnap = await get(ref(database, 'orders'));
    const allOrders = ordersSnap.val() || {};
    
    onValue(ref(database, 'customers'), (snapshot) => {
        const tbody = document.getElementById('customers-list-body');
        if (!tbody) return;
        tbody.innerHTML = "";
        const customers = snapshot.val() || {};

        for (let id in customers) {
            const cust = customers[id];
            const custOrders = Object.values(allOrders).filter(o => o.phone === cust.phone);
            
            // حساب الإحصائيات
            const orderCount = custOrders.length;
            const totalSpent = custOrders.reduce((sum, o) => sum + parseFloat(o.total), 0);
            const avgBill = orderCount > 0 ? (totalSpent / orderCount) : 0;
            
            // حساب متوسط الأيام (بين أول وآخر طلب)
            let avgDays = 0;
            if (orderCount > 1) {
                const dates = custOrders.map(o => new Date(o.date).getTime()).sort();
                const diffTime = dates[dates.length-1] - dates[0];
                avgDays = (diffTime / (1000 * 60 * 60 * 24)) / (orderCount - 1);
            }

            // تصنيف العميل
            let rank = "عادي";
            let rankClass = "";
            if (avgBill >= 20 && avgDays <= 3 && orderCount > 1) { rank = "VVIP ★"; rankClass = "vvip-tag"; }
            else if (avgBill >= 10 && avgDays <= 7 && orderCount > 1) { rank = "VIP"; rankClass = "vip-tag"; }
            
            if (cust.status === 'blocked') { rank = "موقوف ⛔"; rankClass = "blocked-tag"; }

            tbody.innerHTML += `
                <tr class="cust-row" data-rank="${rank.toLowerCase()}">
                    <td><input type="checkbox" class="cust-checkbox" data-id="${id}"></td>
                    <td onclick="viewCustomerOrders('${cust.phone}')" style="cursor:pointer">
                        <div style="font-weight:bold">${cust.name}</div>
                        <div style="font-size:12px; color:#aaa">${cust.phone}</div>
                    </td>
                    <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                    <td style="font-size:12px; text-align:right">
                        عدد: ${orderCount} | متوسط: ${avgBill.toFixed(2)} د.ك<br>
                        كل: ${avgDays.toFixed(1)} يوم
                    </td>
                    <td>${custOrders.length > 0 ? custOrders[custOrders.length-1].date : '-'}</td>
                    <td>
                        <button class="btn-clear" onclick="openBlockModal('${id}', '${cust.name}')">إيقاف</button>
                    </td>
                </tr>`;
        }
    });
};

window.checkCustomerStatus = async function(phone) {
    if (!phone) return true; // إذا لم يتم إدخال رقم، أكمل بشكل عادي

    try {
        const snap = await get(ref(database, 'customers'));
        const customers = snap.val() || {};
        
        // البحث عن الزبون بواسطة رقم الهاتف
        const found = Object.values(customers).find(c => c.phone === phone);
        
        if (found && found.status === 'blocked') {
            // تنبيه الكاشير في مخبز Figs & Olives
            alert(`⚠️ تحذير هام: هذا الزبون موقوف!\nالسبب: ${found.blockReason || 'لم يذكر سبب'}`);
            return false; // العميل موقوف
        }
        
        return true; // العميل سليم أو غير موجود مسبقاً
    } catch (e) {
        console.error("خطأ أثناء فحص حالة الزبون:", e);
        return true; 
    }
};

window.initOrdersLogic = async function() {
    // جلب البيانات اللازمة للفلاتر
    const [pricesSnap, branchesSnap, cashiersSnap] = await Promise.all([
        get(ref(database, 'delivery_areas')),
        get(ref(database, 'branches')),
        get(ref(database, 'cashiers'))
    ]);
    
    // تعبئة قوائم الفلترة
    populateFilter('filter-area', pricesSnap.val(), 'nameAr');
    populateFilter('filter-branch', branchesSnap.val(), 'nameAr');
    populateFilter('filter-cashier', cashiersSnap.val(), 'name');

    onValue(ref(database, 'orders'), (snapshot) => {
        window.allOrdersData = snapshot.val() || {}; // حفظ البيانات للفلترة والطباعة
        renderOrdersTable(window.allOrdersData);
    });
};

function renderOrdersTable(data) {
    const tbody = document.getElementById('orders-list-body');
    if (!tbody) return;
    tbody.innerHTML = "";
    
    for (let id in data) {
        const order = data[id];
        tbody.innerHTML += `
            <tr id="row-${id}">
                <td><input type="checkbox" class="order-checkbox" data-id="${id}"></td>
                <td style="font-weight:bold;">#${order.invoiceNo}</td>
                <td style="text-align:right;">
                    <div>${order.custName}</div>
                    <div style="font-size:11px; color:var(--text-muted);">${order.areaName} | ${order.phone}</div>
                </td>
                <td style="font-size:12px;">
                    <div>${order.date} | ${order.time}</div>
                    <div style="color:var(--primary-blue)">${order.cashierName} - ${order.branchName}</div>
                </td>
                <td style="text-align:right;">
                    صافي: ${parseFloat(order.net).toFixed(3)}<br>
                    توصيل: ${parseFloat(order.delivery).toFixed(3)}<br>
                    <b>الإجمالي: ${parseFloat(order.total).toFixed(3)}</b>
                </td>
                <td><span class="rank-badge" style="background:#e2e8f0; color:#1e293b;">${order.paymentMethod}</span></td>
                <td class="no-print">
                    <button class="btn-main" onclick="openEditOrderModal('${id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-clear" onclick="confirmDeleteOrder('${id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
    }
}

// فحص حالة الجهاز عند التحميل
async function checkDeviceActivation() {
    const deviceId = localStorage.getItem('pos_device_id');
    const snap = await get(ref(database, 'authorized_devices/' + deviceId));
    
    if (!snap.exists() || !snap.val().active) {
        document.body.innerHTML = `<div class="lock-screen">
            <i class="fas fa-lock"></i>
            <h2>عذراً، هذا الجهاز غير مفعل</h2>
            <p>يرجى التواصل مع الإدارة لتفعيل الجهاز رقم: ${deviceId}</p>
        </div>`;
        return false;
    }
    window.currentBranch = snap.val().branchName; // حفظ اسم الفرع المعتمد للجهاز
    return true;
}


// 1. التحقق من تفعيل الجهاز عند الدخول
// استبدل validateDevice في الموديول بهذا الكود
async function validateDevice() {
    const deviceId = localStorage.getItem('figs_pos_id');
    if (!deviceId) return false;

    const snap = await get(ref(database, 'authorized_devices/' + deviceId));
    if (!snap.exists() || !snap.val().active) {
        document.body.innerHTML = `
            <div class="lock-screen">
                <i class="fas fa-lock"></i>
                <h2>عذراً، هذا الجهاز غير مفعل</h2>
                <p>يرجى تزويد الإدارة بالرمز التالي لتفعيل الجهاز: <br> <b>${deviceId}</b></p>
            </div>`;
        return false;
    }
    window.currentBranchName = snap.val().branchName;
    return true;
}

// 2. تطبيق الخصم بكلمة مرور المدير فقط
window.applyManagerDiscount = async function() {
    const password = prompt("يرجى إدخال كلمة مرور المدير للموافقة على الخصم:");
    const settingsSnap = await get(ref(database, 'settings/admin_password'));
    
    if (password === settingsSnap.val()) {
        openDiscountPanel(); // فتح خيارات الخصم (نسبة أو قيمة)
    } else {
        alert("كلمة مرور خاطئة! لا يمكن تطبيق الخصم.");
    }
};





// جلب الأقسام الرئيسية لعرضها كمربعات
window.loadCashierCategories = async function() {
    const snap = await get(ref(database, 'categories'));
    const categories = snap.val() || {};
    const grid = document.getElementById('cashier-grid');
    if(!grid) return;
    grid.innerHTML = "";

    for (let id in categories) {
        grid.innerHTML += `
            <div class="category-card" onclick="loadCashierProducts('${id}')" style="background: var(--accent-color); padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s;">
                <i class="fas fa-folder" style="font-size: 24px; margin-bottom: 10px;"></i>
                <div style="font-size: 14px; font-weight: bold;">${categories[id].nameAr}</div>
            </div>`;
    }
};

// جلب المنتجات داخل قسم معين
window.loadCashierProducts = async function(catId) {
    const snap = await get(ref(database, 'products'));
    const allProducts = snap.val() || {};
    const grid = document.getElementById('cashier-grid');
    grid.innerHTML = `<div onclick="loadCashierCategories()" style="grid-column: 1/-1; color: var(--gold-accent); cursor: pointer; margin-bottom: 10px;"><i class="fas fa-arrow-right"></i> العودة للأقسام</div>`;

    const filtered = Object.entries(allProducts).filter(([id, p]) => p.categoryId === catId);
    
    filtered.forEach(([id, p]) => {
        grid.innerHTML += `
            <div class="product-card" onclick="handleProductClick('${id}')" style="background: var(--secondary-bg); border: 1px solid #444; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer;">
                <div style="font-weight: bold;">${p.nameAr}</div>
                <div style="color: var(--gold-accent); margin-top: 5px;">${parseFloat(p.price).toFixed(3)}</div>
            </div>`;
    });
};

// التعامل مع الباركود
window.handleCashierSearch = async function(e) {
    if (e.key === 'Enter') {
        const value = e.target.value;
        const snap = await get(ref(database, 'products'));
        const products = snap.val() || {};
        const found = Object.values(products).find(p => p.barcode === value || p.nameAr.includes(value));
        
        if (found) {
            handleProductClick(found.id);
            e.target.value = ""; // مسح الخانة بعد الإيجاد
        }
    }
};

// دالة الضغط على المنتج لجلب المخزون الرئيسي
window.handleProductClick = async function(productId) {
    const pSnap = await get(ref(database, 'products/' + productId));
    const sSnap = await get(ref(database, 'inventory/main_branch/' + productId));
    window.openQuantityModal(pSnap.val(), sSnap.val() || 0);
};

// أضف هذه الدالة في نهاية الموديول السفلي
window.updateDeviceLink = async function(deviceId, branchId, branchName) {
    try {
        // تحديث بيانات الجهاز واستخدام الـ deviceId الصحيح
        await update(ref(database, 'authorized_devices/' + deviceId), {
            branchId: branchId,
            branchName: branchName,
            active: true, // تفعيل الجهاز فور الربط
            status: 'online',
            lastSeen: new Date().toLocaleString()
        });
        
        alert("✅ تم ربط الجهاز بفرع (" + branchName + ") وتفعيله بنجاح");
        closeModal(); // إغلاق النافذة تلقائياً
    } catch (e) {
        console.error("خطأ في الربط:", e);
        alert("عذراً، حدث خطأ أثناء الربط: " + e.message);
    }
};

// جلب وعرض المنتجات مع مراقبة نقطة إعادة الطلب
window.initProductsLogic = async function() {
    // 1. جلب بيانات الفروع والتصنيفات
    const [branchesSnap, catsSnap] = await Promise.all([
        get(ref(database, 'branches')),
        get(ref(database, 'categories'))
    ]);
    
    const allCategories = catsSnap.val() || {};
    populateFilter('filter-product-branch', branchesSnap.val(), 'nameAr');
    populateFilter('filter-product-category', allCategories, 'nameAr');

    // 2. دالة مساعدة لبناء مسار الأقسام (Recursion)
    const buildCategoryPath = (catId) => {
        if (!catId || !allCategories[catId]) return "";
        const cat = allCategories[catId];
        // إذا كان هناك قسم أب، قم بجلب اسمه أولاً
        const parentPath = cat.parentId ? buildCategoryPath(cat.parentId) : "";
        return parentPath ? `${parentPath} > ${cat.nameAr}` : cat.nameAr;
    };

    // 3. مراقبة المنتجات بشكل لحظي
    onValue(ref(database, 'products'), (snapshot) => {
        const tbody = document.getElementById('products-list-body');
        if (!tbody) return;
        tbody.innerHTML = "";
        const products = snapshot.val() || {};

        for (let id in products) {
            const p = products[id];
            
            // --- بناء المسار الكامل للقسم ---
            const fullPath = p.categoryId ? buildCategoryPath(p.categoryId) : '<span style="color:#666;">غير مصنف</span>';

            // --- منطق التنبيه بالألوان ---
            let stockColor = "inherit";
            let statusText = "مستقر";
            let rowClass = "";

            if (parseFloat(p.stock) <= parseFloat(p.reorderPoint)) {
                stockColor = "#e94560";
                statusText = "نقص مخزون ⚠️";
                rowClass = "low-stock-critical";
            } else if (parseFloat(p.stock) <= parseFloat(p.reorderPoint) * 1.2) {
                stockColor = "#f39c12";
                statusText = "إعادة طلب قريباً";
                rowClass = "low-stock-warning";
            }

            tbody.innerHTML += `
                <tr class="product-row ${rowClass}">
                    <td>
                        <input type="checkbox" class="product-checkbox" data-id="${id}" data-name="${p.nameAr}">
                    </td>
                    <td style="text-align:right;">
                        <div style="font-weight:bold;">${p.nameAr}</div>
                        <div style="font-size:11px; color:#aaa;">${p.nameEn || ''}</div>
                    </td>
                    <td style="font-size:12px; color:var(--gold-accent); line-height:1.4;">
                        <i class="fas fa-sitemap" style="font-size:10px; margin-left:5px; opacity:0.7;"></i>
                        <b>${fullPath}</b>
                    </td>
                    <td style="font-size:13px;">
                        <span title="التكلفة">${parseFloat(p.cost).toFixed(3)}</span> / 
                        <span title="سعر البيع" style="color:#28a745; font-weight:bold;">${parseFloat(p.price).toFixed(3)}</span>
                    </td>
                    <td style="font-weight:bold; color:${stockColor}">
                        ${p.stock} <small style="color:#aaa;">(${p.unit})</small>
                    </td>
                    <td>
                        <span class="rank-badge" style="background:${stockColor}; font-size:11px;">${statusText}</span>
                    </td>
                    <td style="text-align:center; font-weight:bold; color:var(--gold-accent);">${p.salesCount || 0}</td>
                    <td>
                        <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                            <canvas id="bc-${id}" class="mini-barcode"></canvas>
                            <button onclick="downloadSingleBarcode('${id}', '${p.nameAr}')" 
                                    class="btn-clear" style="padding:2px 8px; font-size:10px; border:1px solid #555;">
                                <i class="fas fa-download"></i> PNG
                            </button>
                        </div>
                    </td>
                    <td>
                        <div style="display:flex; gap:8px; justify-content:center;">
                            <button class="btn-main" style="padding:6px 12px; background:var(--primary-blue);" 
                                    onclick="editProduct('${id}')" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="btn-clear" style="padding:6px 12px; background:#e94560; color:white; border:none;" 
                                    onclick="confirmDeleteProduct('${id}')" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            
            setTimeout(() => {
                if(document.getElementById(`bc-${id}`)) {
                    JsBarcode(`#bc-${id}`, p.barcode, { height: 35, displayValue: true, fontSize: 12 });
                }
            }, 150);
        }
    });
};

// دالة تحميل الباركودات كملف ZIP
window.downloadSelectedBarcodes = async function() {
    const selected = document.querySelectorAll('.product-checkbox:checked');
    if (selected.length === 0) return alert("يرجى تحديد منتجات أولاً");

    const zip = new JSZip();
    const folder = zip.folder("Figs_Olives_Barcodes");

    selected.forEach(cb => {
        const id = cb.dataset.id;
        const nameAr = cb.dataset.name;
        const canvas = document.getElementById(`bc-${id}`);
        const imgData = canvas.toDataURL("image/png").split(',')[1];
        folder.file(`${nameAr}.png`, imgData, {base64: true});
    });

    const content = await zip.generateAsync({type:"blob"});
    saveAs(content, `Barcodes_${Date.now()}.zip`);
};


// محرك قراءة الإكسل وحفظ البيانات في Firebase
window.handleBulkProductImport = async function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        
        const total = rows.length;
        if (total === 0) return alert("الملف فارغ!");

        for (let i = 0; i < total; i++) {
            const row = rows[i];
            const productId = Date.now() + i; // معرف فريد للمنتج
            
            // 1. توليد باركود تلقائي إذا كانت الخانة فارغة في الإكسل
            const barcode = row['الباركود (اختياري)'] || `FIGS${Math.floor(Math.random() * 1000000000)}`;

            // 2. تجهيز كائن المنتج
            const productData = {
                id: productId,
                nameAr: row['الاسم العربي'] || 'منتج بدون اسم',
                nameEn: row['الاسم الإنجليزي'] || '',
                cost: parseFloat(row['التكلفة']) || 0,
                price: parseFloat(row['سعر البيع']) || 0,
                unit: row['الوحدة'] || 'حبة',
                stock: parseFloat(row['المخزون الأولي']) || 0,
                reorderPoint: parseFloat(row['نقطة إعادة الطلب']) || 5,
                barcode: barcode,
                salesCount: 0,
                createdAt: new Date().toISOString()
            };

            // 3. الحفظ في قاعدة البيانات
            await set(ref(database, 'products/' + productId), productData);

            // 4. تحديث المخزون في الفرع الرئيسي آلياً
            await set(ref(database, 'inventory/main_branch/' + productId), productData.stock);

            // 5. تحديث العداد في الواجهة
            window.updateImportProgress(i + 1, total);
        }
    };
    reader.readAsArrayBuffer(file);
};

// 1. مراقب الوحدات لضمان جاهزيتها للقائمة المنسدلة
onValue(ref(database, 'units'), (snapshot) => {
    window.availableUnits = snapshot.val();
});

// 2. دالة الإضافة الفعلية في Firebase
window.addProductToFirebase = async function(data) {
    const productId = Date.now();
    try {
        // 1. حفظ بيانات المنتج بالكامل
        await set(ref(database, 'products/' + productId), { ...data, id: productId });
        
        // 2. تحديث المخزون الفعلي للفرع الرئيسي بهذه القيمة
        await set(ref(database, 'inventory/main_branch/' + productId), data.stock);
        
        alert("✅ تم إضافة المنتج وتعيين المخزون بنجاح");
        closeModal();
    } catch (e) {
        alert("خطأ: " + e.message);
    }
};

// 3. دالة الفلترة حسب المبيعات (الأعلى مبيعاً)
window.filterProductsTable = function() {
    const sortBy = document.getElementById('sort-product-sales').value;
    get(ref(database, 'products')).then(snap => {
        let products = Object.values(snap.val() || {});
        
        if (sortBy === 'high') products.sort((a, b) => (b.salesCount || 0) - (a.salesCount || 0));
        if (sortBy === 'low') products.sort((a, b) => (a.salesCount || 0) - (b.salesCount || 0));
        
        // إعادة رسم الجدول بالبيانات المرتبة
        renderProductsTable(products);
    });
};



// 1. محرك عرض الوحدات ومراقبة التغييرات
window.initUnitsLogic = function() {
    // جلب المنتجات أولاً لحساب عدد المرات التي استُخدمت فيها الوحدة
    get(ref(database, 'products')).then((prodSnap) => {
        const allProducts = prodSnap.val() || {};

        onValue(ref(database, 'units'), (snapshot) => {
            const tbody = document.getElementById('units-list-body');
            if (!tbody) return;
            tbody.innerHTML = "";
            const data = snapshot.val() || {};

            for (let id in data) {
                const u = data[id];
                // حساب عدد المنتجات التي تستخدم هذه الوحدة
                const count = Object.values(allProducts).filter(p => p.unit === u.nameAr).length;

                tbody.innerHTML += `
                    <tr>
                        <td onclick="window.viewUnitProducts('${u.nameAr}')" style="cursor:pointer; color:var(--gold-accent); font-weight:bold;">
                            ${u.nameAr} <i class="fas fa-external-link-alt" style="font-size:10px;"></i>
                        </td>
                        <td>${u.nameEn}</td>
                        <td><span class="rank-badge" style="background:#444;">${count} منتج</span></td>
                        <td>
                            <button class="btn-clear" style="padding:5px 10px;" onclick="window.deleteUnit('${id}')">حذف</button>
                        </td>
                    </tr>`;
            }
        });
    });
};

// 2. دالة حفظ الوحدة في Firebase
window.addUnitToFirebase = async function(unitData) {
    const id = Date.now();
    try {
        await set(ref(database, 'units/' + id), unitData);
        alert("✅ تم إضافة الوحدة بنجاح");
        closeModal();
    } catch (e) {
        alert("خطأ: " + e.message);
    }
};

// 3. دالة عرض المنتجات المرتبطة بوحدة محددة (تظهر في مودال)
window.viewUnitProducts = async function(unitName) {
    const snap = await get(ref(database, 'products'));
    const products = snap.val() || {};
    const filtered = Object.values(products).filter(p => p.unit === unitName);

    let listHtml = filtered.length > 0 
        ? filtered.map(p => `<li>${p.nameAr} (${p.price} د.ك)</li>`).join('')
        : "<li>لا توجد منتجات مرتبطة بهذه الوحدة حالياً</li>";

    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>منتجات وحدة: ${unitName}</h3>
                <ul style="text-align:right; margin-top:15px; color:#fff;">${listHtml}</ul>
                <button class="btn-main" style="margin-top:20px;" onclick="closeModal()">إغلاق</button>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};


// 1. دالة حذف الوحدة
window.deleteUnit = async function(id) {
    if (confirm(translations[currentLang].deleteConfirm)) {
        try {
            await set(ref(database, 'units/' + id), null);
            alert("✅ تم حذف الوحدة بنجاح");
        } catch (e) { alert("خطأ في الحذف: " + e.message); }
    }
};

// 2. دالة تحميل باركود واحد فقط
window.downloadSingleBarcode = function(id, nameAr) {
    const canvas = document.getElementById(`bc-${id}`);
    if (canvas) {
        const link = document.createElement('a');
        link.download = `${nameAr}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
};


// 4. دالة تحميل تقرير المنتجات إكسل
window.exportProductsExcel = async function() {
    const snap = await get(ref(database, 'products'));
    const products = Object.values(snap.val() || {});
    
    if (products.length === 0) return alert("لا توجد منتجات لتصديرها");

    const data = products.map(p => ({
        "الاسم": p.nameAr,
        "التكلفة": p.cost,
        "سعر البيع": p.price,
        "المخزون": p.stock,
        "الوحدة": p.unit,
        "الباركود": p.barcode,
        "مرات البيع": p.salesCount || 0
    }));

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Products Report");
    XLSX.writeFile(workbook, `Figs_Olives_Inventory_${Date.now()}.xlsx`);
};

// 5. دالة تحديد الكل في جدول المنتجات
window.toggleAllProducts = function(source) {
    const checkboxes = document.querySelectorAll('.product-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
};

window.refreshProductStock = async function() {
    const branchId = document.getElementById('filter-product-branch').value;
    // هنا يمكن تحديث عرض المخزون بناءً على الفرع المختار
    console.log("تغيير عرض المخزون للفرع:", branchId);
    window.initProductsLogic(); // إعادة تحميل البيانات
};


// دالة تحديث بيانات المنتج
window.updateProductInFirebase = async function(id, data) {
    try {
        // تحديث سجل المنتج
        await update(ref(database, 'products/' + id), data);
        // تحديث المخزون في الفرع الرئيسي لضمان التطابق
        await set(ref(database, 'inventory/main_branch/' + id), data.stock);
        
        alert("✅ تم تحديث بيانات المنتج بنجاح");
        closeModal();
    } catch (e) { alert("خطأ في التحديث: " + e.message); }
};

// دالة حذف المنتج من كافة السجلات
window.deleteProductFromFirebase = async function(id) {
    try {
        await set(ref(database, 'products/' + id), null);
        await set(ref(database, 'inventory/main_branch/' + id), null);
        alert("✅ تم حذف المنتج بنجاح");
    } catch (e) { alert("خطأ في الحذف: " + e.message); }
};


// محرك عرض التصنيفات والمنتجات
window.initCategoriesLogic = async function(parentId) {
    const catGrid = document.getElementById('categories-grid');
    if (!catGrid) return;

    // 1. جلب الأقسام التابعة لهذا الـ ID
    onValue(ref(database, 'categories'), (snapshot) => {
        catGrid.innerHTML = "";
        const allCats = snapshot.val() || {};
        
        // عرض الأقسام
        for (let id in allCats) {
            const cat = allCats[id];
            if (cat.parentId == parentId) {
                catGrid.innerHTML += `
                    <div class="category-card" onclick="enterCategory('${id}', '${cat.nameAr}')" style="background:#0f3460; padding:20px; border-radius:12px; cursor:pointer; position:relative; text-align:center; border:1px solid #16213e;">
                        <i class="fas fa-folder" style="font-size:2rem; color:var(--gold-accent); margin-bottom:10px;"></i>
                        <div style="font-weight:bold;">${cat.nameAr}</div>
                        <div style="font-size:12px; color:#aaa;">${cat.nameEn}</div>
                        <button onclick="event.stopPropagation(); deleteCategory('${id}')" style="position:absolute; top:5px; left:5px; background:none; border:none; color:#e94560;"><i class="fas fa-times"></i></button>
                    </div>`;
            }
        }

        // 2. عرض المنتجات المضافة لهذا القسم
        get(ref(database, 'products')).then(prodSnap => {
            const products = prodSnap.val() || {};
            for (let pid in products) {
                const p = products[pid];
                if (p.categoryId == parentId && parentId !== null) {
                    catGrid.innerHTML += `
                        <div class="product-card-mini" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; text-align:center; border:1px dashed #444;">
                            <i class="fas fa-box" style="color:#aaa; margin-bottom:8px;"></i>
                            <div style="font-size:14px;">${p.nameAr}</div>
                            <button onclick="removeProductFromCategory('${pid}')" class="btn-clear" style="font-size:10px; padding:2px 5px; margin-top:5px;">إزالة من القسم</button>
                        </div>`;
                }
            }
        });
    });
};

// الدخول لقسم معين
window.enterCategory = function(id, name) {
    window.categoryPath.push({ id, name });
    loadCategoriesPage();
};

// حفظ قسم جديد في Firebase
window.saveCategory = async function(parentId) {
    const nameAr = document.getElementById('cat-name-ar').value;
    const nameEn = document.getElementById('cat-name-en').value;
    if (!nameAr) return alert("يرجى إدخال اسم القسم");

    const id = Date.now();
    await set(ref(database, 'categories/' + id), {
        id,
        nameAr,
        nameEn,
        parentId: parentId === 'null' ? null : parentId,
        createdAt: new Date().toISOString()
    });
    closeModal();
};

// نافذة اختيار المنتجات (التي ليست في أي قسم)
window.openAddProductToCategoryModal = async function(categoryId) {
    const snap = await get(ref(database, 'products'));
    const products = snap.val() || {};
    
    let listHtml = "";
    for (let id in products) {
        // شرط: لا تظهر إلا المنتجات التي ليس لها قسم (Unclassified)
        if (!products[id].categoryId) {
            listHtml += `
                <label style="display:flex; align-items:center; gap:10px; background:#1a1a2e; padding:10px; margin-bottom:5px; border-radius:5px; cursor:pointer;">
                    <input type="checkbox" class="cat-prod-check" value="${id}">
                    <span>${products[id].nameAr}</span>
                </label>`;
        }
    }

    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
                <h3>إضافة منتجات للقسم</h3>
                <div id="unclassified-list">${listHtml || 'لا توجد منتجات غير مصنفة حالياً'}</div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmAddProductsToCat('${categoryId}')">إضافة المختارة</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// ربط المنتجات بالقسم في Firebase
window.confirmAddProductsToCat = async function(categoryId) {
    const checks = document.querySelectorAll('.cat-prod-check:checked');
    for (let check of checks) {
        const productId = check.value;
        await update(ref(database, 'products/' + productId), { categoryId: categoryId });
    }
    alert("✅ تم ربط المنتجات بالقسم");
    closeModal();
    loadCategoriesPage();
};

// إزالة منتج من قسم (يعود غير مصنف)
window.removeProductFromCategory = async function(productId) {
    if (confirm("هل تريد إزالة المنتج من هذا القسم؟ سيعود للمنتجات 'غير المصنفة'.")) {
        await update(ref(database, 'products/' + productId), { categoryId: null });
        loadCategoriesPage();
    }
};

// حذف قسم
window.deleteCategory = async function(id) {
    if (confirm("تحذير: عند حذف القسم، ستصبح جميع المنتجات والأقسام الفرعية بداخله 'غير مصنفة'. هل أنت متأكد؟")) {
        // 1. جعل المنتجات التابعة له بدون قسم
        const prodSnap = await get(ref(database, 'products'));
        const products = prodSnap.val() || {};
        for (let pid in products) {
            if (products[pid].categoryId == id) {
                await update(ref(database, 'products/' + pid), { categoryId: null });
            }
        }
        // 2. حذف القسم نفسه
        await set(ref(database, 'categories/' + id), null);
    }
};


// مراقبة مواد المخزون
window.initInventoryItemsLogic = async function() {
    const branchId = document.getElementById('inv-filter-branch')?.value || 'main';
    const [branchesSnap, storageSnap] = await Promise.all([
        get(ref(database, 'branches')),
        get(ref(database, 'storage_locations'))
    ]);
    
    populateFilter('inv-filter-branch', branchesSnap.val(), 'nameAr');
    populateFilter('inv-filter-storage', storageSnap.val(), 'nameAr');

    onValue(ref(database, 'inventory_items'), (snapshot) => {
        const tbody = document.getElementById('inv-items-list-body');
        if (!tbody) return;
        tbody.innerHTML = "";
        const items = snapshot.val() || {};

        for (let id in items) {
            const item = items[id];
            // جلب المخزون الخاص بالفرع المختار
            const branchStock = item.branches?.[branchId]?.stock || 0;
            
            // منطق الألوان
            let statusColor = "#28a745"; 
            if (branchStock <= item.reorderPoint) statusColor = "#e94560";
            else if (branchStock <= item.reorderPoint * 1.2) statusColor = "#f39c12";

            tbody.innerHTML += `
                <tr>
                    <td><input type="checkbox" class="inv-checkbox" data-id="${id}" data-name="${item.nameAr}"></td>
                    <td><b>${item.nameAr}</b></td>
                    <td>${parseFloat(item.cost).toFixed(3)}</td>
                    <td style="color:${statusColor}; font-weight:bold;">${branchStock} (${item.unit})</td>
                    <td><div style="width:15px; height:15px; border-radius:50%; background:${statusColor}; margin:auto;"></div></td>
                    <td>${item.storageName || 'غير محدد'}</td>
                    <td>${item.prodIdentified || 0}</td>
                    <td>${item.prodUnidentified || 0}</td>
                    <td>${item.salesCount || 0}</td>
                    <td><canvas id="inv-bc-${id}" style="width:80px;"></canvas></td>
                    <td>
                        <button class="btn-main" onclick="editInvItem('${id}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>`;
            
            setTimeout(() => {
                JsBarcode(`#inv-bc-${id}`, item.barcode || id, { height: 30, displayValue: true, fontSize: 10 });
            }, 100);
        }
    });
};

// محرك الاستيراد الجماعي للمواد
window.handleBulkInvProductImport = async function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = async (e) => {
        const rows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type:'array'}).SheetNames[0]]);
        const total = rows.length;
        document.getElementById('inv-import-progress').style.display = 'block';

        for (let i = 0; i < total; i++) {
            const row = rows[i];
            const id = Date.now() + i;
            const itemData = {
                id,
                nameAr: row['الاسم العربي'],
                nameEn: row['الاسم الإنجليزي'] || '',
                cost: parseFloat(row['التكلفة']) || 0,
                unit: row['الوحدة'] || 'حبة',
                reorderPoint: parseFloat(row['نقطة إعادة الطلب']) || 5,
                barcode: row['الباركود'] || "INV" + id,
                branches: { 'main': { stock: parseFloat(row['المخزون الأولي']) || 0 } },
                salesCount: 0,
                prodIdentified: 0,
                prodUnidentified: parseFloat(row['المخزون الأولي']) || 0
            };
            await set(ref(database, 'inventory_items/' + id), itemData);
            
            const percent = Math.round(((i + 1) / total) * 100);
            document.getElementById('inv-progress-bar').value = percent;
            document.getElementById('inv-progress-text').innerText = `تم رفع ${i+1} من ${total}`;
        }
        alert("✅ اكتمل استيراد مواد المخزون");
        document.getElementById('inv-import-progress').style.display = 'none';
    };
    reader.readAsArrayBuffer(file);
};

// 1. حفظ المادة الجديدة في قاعدة البيانات
window.saveNewInvItem = async function() {
    const nameAr = document.getElementById('inv-name-ar').value;
    const cost = document.getElementById('inv-cost').value;
    const unit = document.getElementById('inv-unit-select').value;
    const stock = document.getElementById('inv-stock').value;
    const reorder = document.getElementById('inv-reorder').value;
    let barcode = document.getElementById('inv-barcode').value || "INV" + Date.now();

    if (!nameAr || !cost) return alert("يرجى إكمال البيانات الأساسية");

    const id = Date.now();
    const itemData = {
        id,
        nameAr,
        nameEn: document.getElementById('inv-name-en').value || '',
        cost: parseFloat(cost),
        unit,
        reorderPoint: parseFloat(reorder) || 5,
        barcode,
        branches: { 'main': { stock: parseFloat(stock) || 0 } },
        prodIdentified: 0,
        prodUnidentified: parseFloat(stock) || 0,
        createdAt: new Date().toISOString()
    };

    try {
        await set(ref(database, 'inventory_items/' + id), itemData);
        alert("✅ تم إضافة مادة المخزون بنجاح");
        closeModal();
    } catch (e) { alert("خطأ: " + e.message); }
};

// 2. تصدير تقرير مواد المخزون إلى إكسل
window.exportInvItemsExcel = async function() {
    const snap = await get(ref(database, 'inventory_items'));
    const items = Object.values(snap.val() || {});
    if (items.length === 0) return alert("لا توجد بيانات لتصديرها");

    const branchId = document.getElementById('inv-filter-branch')?.value || 'main';
    const data = items.map(item => ({
        "المادة": item.nameAr,
        "التكلفة": item.cost,
        "المخزون": item.branches?.[branchId]?.stock || 0,
        "الوحدة": item.unit,
        "مكان التخزين": item.storageName || 'غير محدد',
        "الباركود": item.barcode
    }));

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Inventory Report");
    XLSX.writeFile(workbook, `Inventory_Report_${Date.now()}.xlsx`);
};

</script>
</body>
</html>
