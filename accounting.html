<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tab-title">المحاسبة والمخازن</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="rtl" id="body-tag">


    <div id="login-overlay" class="login-screen">
    <div class="login-box">
        <img src="logo.png" alt="Logo" class="login-logo">
        <h2 id="login-title">تسجيل الدخول للنظام</h2>
        <div class="pin-display">
            <input type="password" id="pin-input" readonly placeholder="******">
        </div>
        <div class="pin-pad">
            <button onclick="appendPin('1')">1</button>
            <button onclick="appendPin('2')">2</button>
            <button onclick="appendPin('3')">3</button>
            <button onclick="appendPin('4')">4</button>
            <button onclick="appendPin('5')">5</button>
            <button onclick="appendPin('6')">6</button>
            <button onclick="appendPin('7')">7</button>
            <button onclick="appendPin('8')">8</button>
            <button onclick="appendPin('9')">9</button>
            <button class="btn-clear" onclick="clearPin()">C</button>
            <button onclick="appendPin('0')">0</button>
            <button class="btn-login" onclick="checkLogin()">Enter</button>
        </div>
        <p id="login-error" style="color: #e94560; margin-top: 15px; display: none;">الرمز غير صحيح!</p>
    </div>
</div>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="logo.png" alt="Logo" style="width: 80px;">
            </div>

            <a class="sidebar-item" id="menu-orders" onclick="loadPage('orders')">الطلبات</a>
            <a class="sidebar-item" id="menu-customers" onclick="loadPage('customers')">العملاء</a>
            <a class="sidebar-item" id="menu-products" onclick="loadPage('products')">المنتجات</a>
            <a class="sidebar-item" id="menu-categories" onclick="loadPage('categories')">التصنيفات</a>
            <a class="sidebar-item" id="menu-units" onclick="loadPage('units')">الوحدات</a>
            <a class="sidebar-item" id="menu-itemcard" onclick="loadPage('itemcard')">بطاقة الصنف</a>

            <div class="sidebar-item dropdown-btn" onclick="toggleDropdown('drop-stores')">
                <span id="menu-stores-title">المخازن</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="drop-stores" class="dropdown-container">
                <a class="sidebar-item" id="sub-inv-items">مواد المخزون</a>
                <a class="sidebar-item" id="sub-storage-locations">أماكن التخزين</a>
                <a class="sidebar-item" id="sub-disbursement">صرف</a>
                <a class="sidebar-item" id="sub-production">انتاج</a>
                <a class="sidebar-item" id="sub-inventory-check">جرد</a>
                <a class="sidebar-item" id="sub-transfers">تحويلات</a>
                <a class="sidebar-item" id="sub-return-store">مرتجع للمخزن</a>
                <a class="sidebar-item" id="sub-return-waste">مرتجع توالف</a>
            </div>

            <div class="sidebar-item dropdown-btn" onclick="toggleDropdown('drop-suppliers')">
                <span id="menu-suppliers-title">الموردون</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="drop-suppliers" class="dropdown-container">
                <a class="sidebar-item" id="sub-suppliers-list">الموردون</a>
                <a class="sidebar-item" id="sub-purchasing">الشراء</a>
                <a class="sidebar-item" id="sub-return-supplier">مرتجع للمورد</a>
            </div>

            <div class="sidebar-item dropdown-btn" onclick="toggleDropdown('drop-admin')">
                <span id="menu-admin-title">الإدارة</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="drop-admin" class="dropdown-container">
                <a class="sidebar-item" id="sub-pending-moves">حركات مخزون معلقة</a>
                <a class="sidebar-item" id="sub-pos-devices" onclick="loadPOSDevicesPage()">الأجهزة والكاشير</a>
                <a class="sidebar-item" id="sub-store-staff" onclick="loadUsersPage()">المستخدمين</a>
                <a class="sidebar-item" id="sub-prod-staff">موظفي الانتاج</a>
                <a class="sidebar-item" id="sub-branches" onclick="loadBranchesPage()">الفروع</a>
                <a class="sidebar-item" id="sub-delivery-areas" onclick="loadDeliveryAreasPage()">مناطق التوصيل</a>
                <a class="sidebar-item" id="sub-delivery-prices">أسعار التوصيل</a>
                <a class="sidebar-item" id="sub-discounts">خصومات</a>
                <a class="sidebar-item" id="sub-payment-types">انواع الطلب وطرق الدفع</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <h2 id="page-title">المحاسبة والمخازن</h2>
                <button id="btn-lang-toggle" class="btn-main" onclick="toggleLanguage()" style="padding: 5px 15px;">English</button>
            </header>
            
            <div id="content-area">
                <p id="welcome-msg">اختر قسماً من القائمة الجانبية للبدء...</p>
            </div>
        </main>
    </div>

    <script>
        // 1. قاموس الترجمة الشامل
        const translations = {
            ar: {
                tabTitle: "المحاسبة والمخازن",
                pageTitle: "المحاسبة والمخازن",
                btnLang: "English",
                welcome: "اختر قسماً من القائمة الجانبية للبدء...",
                orders: "الطلبات",
                customers: "العملاء",
                products: "المنتجات",
                categories: "التصنيفات",
                units: "الوحدات",
                itemcard: "بطاقة الصنف",
                storesTitle: "المخازن",
                invItems: "مواد المخزون",
                storageLoc: "أماكن التخزين",
                disbursement: "صرف",
                production: "انتاج",
                invCheck: "جرد",
                transfers: "تحويلات",
                retStore: "مرتجع للمخزن",
                retWaste: "مرتجع توالف",
                suppTitle: "الموردون",
                suppList: "الموردون",
                purchasing: "الشراء",
                retSupp: "مرتجع للمورد",
                adminTitle: "الإدارة",
                pendingMoves: "حركات مخزون معلقة",
                posDevices: "الأجهزة والكاشير",
                storeStaff: "موظفي المخازن",
                prodStaff: "موظفي الانتاج",
                branches: "الفروع",
                delAreas: "مناطق التوصيل",
                delPrices: "أسعار التوصيل",
                discounts: "خصومات",
                paymentTypes: "انواع الطلب وطرق الدفع",
                posTitle: "إدارة الأجهزة والفروع",
        posInfo: "هنا تظهر جميع الأجهزة التي فتحت النظام. يجب تحديد فرع لكل جهاز لكي يعمل.",
        deviceId: "ID الجهاز",
        status: "الحالة",
        assignedBranch: "الفرع المخصص",
        lastSeen: "آخر ظهور",
        actions: "إجراءات",
        cashierTitle: "إدارة الكاشير",
        addCashier: "+ إضافة كاشير جديد",
        cashierName: "اسم الكاشير",
        pin: "الرمز (PIN)",
        userTitle: "إدارة المستخدمين والصلاحيات",
        addUser: "+ إضافة مستخدم جديد",
        userName: "الاسم",
        userRole: "الدور (الصلاحية)",
        userPin: "رمز الدخول",
        branchTitle: "إدارة الفروع",
        addBranch: "+ إضافة فرع جديد",
        branchInfo: "يجب تحديد فرع واحد فقط كـ 'فرع رئيسي' ليكون مركز استلام المشتريات والمخزون الأولي.",
        nameAr: "الاسم (عربي)",
        nameEn: "الاسم (En)",
        type: "النوع",
        link: "ربط",
        edit: "تعديل",
        delete: "حذف",
        roleManager: "مدير",
        roleStorekeeper: "أمين مخازن",
        roleCashier: "أمين صندوق",
        modalAddUser: "إضافة مستخدم جديد",
        placeholderName: "اسم الموظف",
        placeholderPin: "رمز الدخول (4 أرقام)",
        saveSuccess: "✅ تم حفظ البيانات بنجاح",
        deleteConfirm: "هل أنت متأكد من الحذف؟",
        mainBranchLabel: "تعيين كفرع رئيسي",
        delAreasTitle: "إدارة مناطق وأسعار التوصيل",
    addAreaBtn: "+ إضافة منطقة جديدة",
    areaNameAr: "اسم المنطقة (عربي)",
    areaNameEn: "اسم المنطقة (En)",
    deliveryPrice: "سعر التوصيل",
    modalAddArea: "إضافة منطقة توصيل جديدة",
    modalEditArea: "تعديل منطقة التوصيل",
    placeholderPrice: "0.000",
    saveBtn: "حفظ المنطقة"
        
            },
            en: {
                tabTitle: "Accounting System",
                pageTitle: "Accounting & Stores",
                btnLang: "عربي",
                welcome: "Select a department from the sidebar to start...",
                orders: "Orders",
                customers: "Customers",
                products: "Products",
                categories: "Categories",
                units: "Units",
                itemcard: "Item Card",
                storesTitle: "Stores",
                invItems: "Inventory Items",
                storageLoc: "Storage Locations",
                disbursement: "Disbursement",
                production: "Production",
                invCheck: "Inventory Check",
                transfers: "Transfers",
                retStore: "Store Return",
                retWaste: "Waste Return",
                suppTitle: "Suppliers",
                suppList: "Suppliers List",
                purchasing: "Purchasing",
                retSupp: "Supplier Return",
                adminTitle: "Admin",
                pendingMoves: "Pending Inventory",
                posDevices: "POS Devices",
                storeStaff: "Store Staff",
                prodStaff: "Production Staff",
                branches: "Branches",
                delAreas: "Delivery Areas",
                delPrices: "Delivery Prices",
                discounts: "Discounts",
                paymentTypes: "Payment & Order Types",
                posTitle: "Devices & Branches Management",
        posInfo: "All devices that accessed the system. A branch must be assigned to each device to work.",
        deviceId: "Device ID",
        status: "Status",
        assignedBranch: "Assigned Branch",
        lastSeen: "Last Seen",
        actions: "Actions",
        cashierTitle: "Cashier Management",
        addCashier: "+ Add New Cashier",
        cashierName: "Cashier Name",
        pin: "PIN Code",
        userTitle: "Users & Permissions",
        addUser: "+ Add New User",
        userName: "Name",
        userRole: "Role",
        userPin: "Entry PIN",
        branchTitle: "Branch Management",
        addBranch: "+ Add New Branch",
        branchInfo: "Only one branch must be set as 'Main Branch' for receiving inventory.",
        nameAr: "Name (Ar)",
        nameEn: "Name (En)",
        type: "Type",
        link: "Link",
        edit: "Edit",
        delete: "Delete",
        roleManager: "Manager",
        roleStorekeeper: "Storekeeper",
        roleCashier: "Cashier",
        modalAddUser: "Add New User",
        placeholderName: "Employee Name",
        placeholderPin: "PIN Code (4 Digits)",
        saveSuccess: "✅ Data saved successfully",
        deleteConfirm: "Are you sure you want to delete?",
        mainBranchLabel: "Set as Main Branch",
        delAreasTitle: "Delivery Areas & Prices",
    addAreaBtn: "+ Add New Area",
    areaNameAr: "Area Name (Ar)",
    areaNameEn: "Area Name (En)",
    deliveryPrice: "Delivery Fee",
    modalAddArea: "Add New Delivery Area",
    modalEditArea: "Edit Delivery Area",
    placeholderPrice: "0.000",
    saveBtn: "Save Area"
            }
        };

        let currentLang = 'ar';

        // 2. وظيفة تبديل اللغة (تحديث كل الـ IDs)
        window.toggleLanguage = function() {
            currentLang = (currentLang === 'ar') ? 'en' : 'ar';
            const body = document.getElementById('body-tag');
            body.className = (currentLang === 'ar') ? 'rtl' : 'ltr';
            
            const lang = translations[currentLang];

            // تحديث كل عنصر بناءً على الـ ID الخاص به
            document.getElementById('tab-title').innerText = lang.tabTitle;
            document.getElementById('page-title').innerText = lang.pageTitle;
            document.getElementById('btn-lang-toggle').innerText = lang.btnLang;
            if(document.getElementById('welcome-msg')) document.getElementById('welcome-msg').innerText = lang.welcome;

            document.getElementById('menu-orders').innerText = lang.orders;
            document.getElementById('menu-customers').innerText = lang.customers;
            document.getElementById('menu-products').innerText = lang.products;
            document.getElementById('menu-categories').innerText = lang.categories;
            document.getElementById('menu-units').innerText = lang.units;
            document.getElementById('menu-itemcard').innerText = lang.itemcard;

            document.getElementById('menu-stores-title').innerText = lang.storesTitle;
            document.getElementById('sub-inv-items').innerText = lang.invItems;
            document.getElementById('sub-storage-locations').innerText = lang.storageLoc;
            document.getElementById('sub-disbursement').innerText = lang.disbursement;
            document.getElementById('sub-production').innerText = lang.production;
            document.getElementById('sub-inventory-check').innerText = lang.invCheck;
            document.getElementById('sub-transfers').innerText = lang.transfers;
            document.getElementById('sub-return-store').innerText = lang.retStore;
            document.getElementById('sub-return-waste').innerText = lang.retWaste;

            document.getElementById('menu-suppliers-title').innerText = lang.suppTitle;
            document.getElementById('sub-suppliers-list').innerText = lang.suppList;
            document.getElementById('sub-purchasing').innerText = lang.purchasing;
            document.getElementById('sub-return-supplier').innerText = lang.retSupp;

            document.getElementById('menu-admin-title').innerText = lang.adminTitle;
            document.getElementById('sub-pending-moves').innerText = lang.pendingMoves;
            document.getElementById('sub-pos-devices').innerText = lang.posDevices;
            document.getElementById('sub-store-staff').innerText = lang.storeStaff;
            document.getElementById('sub-prod-staff').innerText = lang.prodStaff;
            document.getElementById('sub-branches').innerText = lang.branches;
            document.getElementById('sub-delivery-areas').innerText = lang.delAreas;
            document.getElementById('sub-delivery-prices').innerText = lang.delPrices;
            document.getElementById('sub-discounts').innerText = lang.discounts;
            document.getElementById('sub-payment-types').innerText = lang.paymentTypes;
        };

        // وظيفة القوائم المنسدلة
        window.toggleDropdown = function(id) {
            document.getElementById(id).classList.toggle('show');
        };

        // سيتم برمجة وظيفة تحميل الصفحات حبة حبة
        window.loadPage = function(page) {
            console.log("جاري تحميل صفحة: " + page);
        };

        // --- كود نظام الدخول والتعرف على الجهاز ---
    let pinCode = "";

    window.appendPin = function(num) {
        if (pinCode.length < 6) {
            pinCode += num;
            document.getElementById('pin-input').value = "*".repeat(pinCode.length);
        }
    }

    window.clearPin = function() {
        pinCode = "";
        document.getElementById('pin-input').value = "";
        document.getElementById('login-error').style.display = "none";
    }

    window.checkLogin = function() {
    const errorMsg = document.getElementById('login-error');
    // استدعاء وظيفة التحقق الموجودة في الموديول
    if (window.verifyUserLogin) {
        window.verifyUserLogin(pinCode);
    } else {
        console.error("محرك الدخول لم يكتمل تحميله بعد");
    }
}

    function proceedToSystem() {
        document.getElementById('login-overlay').style.display = "none";
        checkDeviceBinding();
    }

    function checkDeviceBinding() {
    // نستخدم localStorage هنا لكي لا يتغير الـ ID للجهاز ابداً
    let deviceID = localStorage.getItem('fawatirr_device_id');
    if (!deviceID) {
        deviceID = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        localStorage.setItem('fawatirr_device_id', deviceID);
    }
    console.log("هوية الجهاز الحالية:", deviceID);
}

    // فحص حالة الدخول عند تحميل الصفحة
    window.addEventListener('DOMContentLoaded', (event) => {
        if (sessionStorage.getItem('userRole')) {
            document.getElementById('login-overlay').style.display = "none";
        }
    });


    // نافذة إضافة "كاشير" (لنظام المبيعات فقط)
window.openAddCashierModal = function() {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>إضافة كاشير جديد (مبيعات)</h3>
                <input type="text" id="cashier-name-input" placeholder="اسم الكاشير">
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="cashier-pin-input" placeholder="رمز الدخول (4 أرقام)" maxlength="4">
                    <button class="btn-main" onclick="generateCashierPin()">إنشاء رمز</button>
                </div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveNewCashier()">حفظ الكاشير</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// دالة إنشاء رمز من 4 أرقام تلقائياً
window.generateCashierPin = function() {
    const pin = Math.floor(1000 + Math.random() * 9000); // توليد 4 أرقام
    document.getElementById('cashier-pin-input').value = pin;
};

window.closeModal = function() {
    const modal = document.getElementById('modal-overlay');
    if (modal) modal.remove();
}

window.generateRandomPin = function() {
    const pin = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('cashier-pin').value = pin;
}



    // أضف هذه الدوال في السكربت العادي (الدوال العامة)

window.loadPOSDevicesPage = function() {
    const lang = translations[currentLang]; 
    let html = `
        <div class="admin-section">
            <h3><i class="fas fa-network-wired"></i> ${lang.posTitle}</h3>
            <div class="info-card">${lang.posInfo}</div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.deviceId}</th>
                        <th>${lang.status}</th>
                        <th>${lang.assignedBranch}</th>
                        <th>${lang.lastSeen}</th>
                        <th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="devices-live-list"></tbody>
            </table>

            <hr style="margin: 40px 0; border: 0; border-top: 1px dashed rgba(255,255,255,0.1);">

            <div class="header-flex">
                <h3><i class="fas fa-users-cog"></i> ${lang.cashierTitle}</h3>
                <button class="btn-main" onclick="openAddCashierModal()">${lang.addCashier}</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.cashierName}</th>
                        <th>${lang.pin}</th>
                        <th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="cashiers-list-body"></tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    if(window.initDevicesAndCashiers) window.initDevicesAndCashiers();
};




window.editDevice = function(id) {
    alert("تعديل الجهاز رقم: " + id);
}



window.openEditDeviceModal = function(deviceId, currentBranch) {
    let branchesOptions = '<option value="">-- اختر فرعاً --</option>';
    
    // استخدام الأفرع التي تم جلبها من فايربيس
    if (window.availableBranches) {
        for (let id in window.availableBranches) {
            const b = window.availableBranches[id];
            branchesOptions += `<option value="${id}">${b.nameAr}</option>`;
        }
    }

    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>ربط الجهاز بفرع</h3>
                <p style="font-size:12px; color:#aaa;">الجهاز: ${deviceId}</p>
                <select id="select-branch-link" style="width:100%; padding:10px; background:#1a1a2e; color:white;">
                    ${branchesOptions}
                </select>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmLink('${deviceId}')">حفظ الربط</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

window.confirmLink = function(deviceId) {
    const select = document.getElementById('select-branch-link');
    const branchId = select.value;
    const branchName = select.options[select.selectedIndex].text;
    
    if (!branchId) { alert("يرجى اختيار فرع"); return; }
    
    // استدعاء وظيفة التحديث الموجودة في الموديول
    if (window.updateDeviceLink) {
        window.updateDeviceLink(deviceId, branchId, branchName);
    }
}



window.loadBranchesPage = function() {
    const lang = translations[currentLang]; // أضف هذا السطر
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-store"></i> ${lang.branchTitle}</h3> <button class="btn-main" onclick="openAddBranchModal()">${lang.addBranch}</button> </div>
            <div class="info-card" style="margin-top:10px;">
                <i class="fas fa-info-circle"></i> ${lang.branchInfo} </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.nameAr}</th><th>${lang.nameEn}</th><th>${lang.type}</th><th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="branches-list-body">
                    <tr><td colspan="4">...</td></tr>
                </tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    // استدعاء دالة جلب البيانات من الموديول
    // استبدل السطر الأخير في دالة loadBranchesPage بهذا الكود الذكي:
if (window.listenToBranches) {
    window.listenToBranches();
} else {
    // إذا لم يحمل الموديول بعد، انتظر ثانية وحاول مجدداً
    setTimeout(() => { if(window.listenToBranches) window.listenToBranches(); }, 1000);
}
};

window.openAddBranchModal = function() {
    const lang = translations[currentLang];
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.addBranch}</h3>
                <input type="text" id="branch-ar" placeholder="${lang.nameAr}">
                <input type="text" id="branch-en" placeholder="${lang.nameEn}">
                <label style="color:white; display:block; margin-top:15px; text-align:right;">
                    <input type="checkbox" id="is-main-branch"> ${lang.mainBranchLabel}
                </label>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="saveNewBranch()">${lang.addUser}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};
    


// وظيفة فتح نافذة تعديل الفرع
window.openEditBranchModal = function(id, nameAr, nameEn, isMain) {
    // تحويل القيمة النصية لـ isMain إلى Boolean للتحقق منها في الـ Checkbox
    const checked = isMain === 'true' ? 'checked' : '';
    
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>تعديل بيانات الفرع</h3>
                <input type="text" id="edit-branch-ar" value="${nameAr}" placeholder="اسم الفرع بالعربي">
                <input type="text" id="edit-branch-en" value="${nameEn}" placeholder="Branch Name (English)">
                <label style="color:white; display:block; margin-top:15px; text-align:right;">
                    <input type="checkbox" id="edit-is-main-branch" ${checked}> تعيين كفرع رئيسي
                </label>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmBranchUpdate('${id}')">حفظ التغييرات</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// وظيفة تأكيد التعديل وجمع البيانات الجديدة
window.confirmBranchUpdate = function(id) {
    const nameAr = document.getElementById('edit-branch-ar').value;
    const nameEn = document.getElementById('edit-branch-en').value;
    const isMain = document.getElementById('edit-is-main-branch').checked;

    if (!nameAr || !nameEn) {
        alert("يرجى إكمال الحقول المطلوبة");
        return;
    }

    // استدعاء وظيفة التحديث الموجودة في الموديول
    if (window.updateBranchInFirebase) {
        window.updateBranchInFirebase(id, nameAr, nameEn, isMain);
    }
}



// 1. واجهة إدارة المستخدمين
window.loadUsersPage = function() {
    const lang = translations[currentLang];
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-user-shield"></i> ${lang.userTitle}</h3>
                <button class="btn-main" onclick="openAddUserModal()">${lang.addUser}</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr><th>${lang.userName}</th><th>${lang.userRole}</th><th>${lang.userPin}</th><th>${lang.actions}</th></tr>
                </thead>
                <tbody id="users-list-body"></tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    window.initUsersLogic();
};

window.openAddUserModal = function() {
    const lang = translations[currentLang]; // استدعاء اللغة الحالية
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.addUser}</h3>
                <input type="text" id="user-name-input" placeholder="${lang.placeholderName}">
                <select id="user-role-select" style="width:100%; padding:10px; margin-top:15px; background:#1a1a2e; color:white;">
                    <option value="أمين صندوق">${lang.roleCashier}</option>
                    <option value="أمين مخازن">${lang.roleStorekeeper}</option>
                    <option value="مدير">${lang.roleManager}</option>
                </select>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input type="text" id="user-pin-input" placeholder="${lang.placeholderPin}" maxlength="4">
                    <button class="btn-main" onclick="generateUserPin()">${lang.link}</button>
                </div>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmSaveUser()">${lang.edit}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// دالة توليد رمز من 4 أرقام للمستخدمين

window.generateUserPin = function() {

    const pin = Math.floor(1000 + Math.random() * 9000); 

    document.getElementById('user-pin-input').value = pin;

};

// 2. نافذة تعديل مستخدم (أصلحت لتستقبل البيانات)
window.openEditUserModal = function(pin, name, role) {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>تعديل مستخدم</h3>
                <p>الرمز: ${pin}</p>
                <input type="text" id="edit-user-name" value="${name}">
                <select id="edit-user-role" style="width:100%; padding:10px; margin-top:10px; background:#1a1a2e; color:white;">
                    <option value="أمين صندوق" ${role === 'أمين صندوق' ? 'selected' : ''}>أمين صندوق</option>
                    <option value="أمين مخازن" ${role === 'أمين مخازن' ? 'selected' : ''}>أمين مخازن</option>
                    <option value="مدير" ${role === 'مدير' ? 'selected' : ''}>مدير</option>
                </select>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmUserUpdate('${pin}')">تعديل</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

// 3. نافذة تعديل الكاشير (التي كانت تسبب الخطأ)
window.openEditCashierModal = function(pin, name) {
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>تعديل بيانات الكاشير</h3>
                <p>الرمز: ${pin}</p>
                <input type="text" id="edit-cashier-name" value="${name}">
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmCashierUpdate('${pin}')">حفظ</button>
                    <button class="btn-clear" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.confirmUserUpdate = function(pin) {
    const name = document.getElementById('edit-user-name').value;
    const role = document.getElementById('edit-user-role').value;
    if (!name) return alert("يرجى إدخال الاسم");
    // استدعاء دالة التحديث الموجودة داخل الموديول
    if (window.updateUserInFirebase) window.updateUserInFirebase(pin, name, role);
};

// 2. جسر تعديل الكاشير
window.confirmCashierUpdate = function(pin) {
    const name = document.getElementById('edit-cashier-name').value;
    if (!name) return alert("يرجى إدخال الاسم");
    // استدعاء دالة التحديث الموجودة داخل الموديول
    if (window.updateCashierInFirebase) window.updateCashierInFirebase(pin, name);
};

window.loadDeliveryAreasPage = function() {
    const lang = translations[currentLang]; // جلب اللغة الحالية
    let html = `
        <div class="admin-section">
            <div class="header-flex">
                <h3><i class="fas fa-truck"></i> ${lang.delAreasTitle}</h3>
                <button class="btn-main" onclick="openAddAreaModal()">${lang.addAreaBtn}</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>${lang.areaNameAr}</th>
                        <th>${lang.areaNameEn}</th>
                        <th>${lang.deliveryPrice}</th>
                        <th>${lang.actions}</th>
                    </tr>
                </thead>
                <tbody id="delivery-areas-list">
                    <tr><td colspan="4">${currentLang === 'ar' ? 'جاري التحميل...' : 'Loading...'}</td></tr>
                </tbody>
            </table>
        </div>`;
    document.getElementById('content-area').innerHTML = html;
    
    // تشغيل محرك البيانات
    if (window.initDeliveryAreasLogic) window.initDeliveryAreasLogic();
};

// دالة نافذة التعديل (يجب إضافتها هنا)
window.openEditAreaModal = function(id, nameAr, nameEn, price) {
    const lang = translations[currentLang];
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.modalEditArea}</h3>
                <input type="text" id="edit-area-ar" value="${nameAr}" placeholder="${lang.areaNameAr}">
                <input type="text" id="edit-area-en" value="${nameEn}" placeholder="${lang.areaNameEn}">
                <input type="number" id="edit-area-price" value="${price}" placeholder="${lang.deliveryPrice}" step="0.001">
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmAreaUpdate('${id}')">${lang.edit}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

window.confirmAreaUpdate = function(id) {
    const nameAr = document.getElementById('edit-area-ar').value;
    const nameEn = document.getElementById('edit-area-en').value;
    const price = document.getElementById('edit-area-price').value;
    if (window.updateAreaInFirebase) window.updateAreaInFirebase(id, nameAr, nameEn, price);
};


window.openAddAreaModal = function() {
    const lang = translations[currentLang];
    let modalHtml = `
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-box">
                <h3>${lang.modalAddArea}</h3>
                <input type="text" id="area-name-ar" placeholder="${lang.areaNameAr}">
                <input type="text" id="area-name-en" placeholder="${lang.areaNameEn}">
                <input type="number" id="area-price" placeholder="${lang.deliveryPrice}" step="0.001">
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="btn-login" onclick="confirmSaveArea()">${lang.saveBtn}</button>
                    <button class="btn-clear" onclick="closeModal()">${lang.delete}</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
};

    </script>

    <script type="module">
    import { database, ref, onValue, set, get, update } from './firebase-config.js?v=2';

    // 1. مراقب الفروع العام (يعمل فوراً لضمان جاهزية قائمة الربط)
    onValue(ref(database, 'branches'), (snapshot) => {
        window.availableBranches = snapshot.val();
        console.log("قاعدة بيانات الفروع جاهزة");
    });

    window.initDevicesAndCashiers = function() {
    const lang = translations[currentLang]; // جلب اللغة الحالية

    // 1. مراقبة الأجهزة (Authorized Devices)
    onValue(ref(database, 'authorized_devices'), (snapshot) => {
        const tbody = document.getElementById('devices-live-list');
        if (!tbody) return;
        tbody.innerHTML = "";
        const data = snapshot.val();
        
        for (let id in data) {
            const d = data[id];
            // ترجمة اسم الفرع في حال لم يكن محدداً
            const branchDisplayName = d.branchName && d.branchName !== "غير محدد" 
                ? d.branchName 
                : (currentLang === 'ar' ? 'غير محدد' : 'Not Assigned');

            tbody.innerHTML += `
                <tr>
                    <td>${d.id}</td>
                    <td style="color:${d.status === 'online' ? '#28a745' : '#888'}">${d.status}</td>
                    <td>${branchDisplayName}</td>
                    <td>${d.lastSeen || '-'}</td>
                    <td>
                        <button class="btn-main link-device-btn" 
                                data-id="${d.id}" 
                                data-name="${d.branchName}">
                            ${lang.link}
                        </button>
                    </td>
                </tr>`;
        }
    });

    // 2. مراقبة الكاشير (Cashiers)
    onValue(ref(database, 'cashiers'), (snapshot) => {
        const tbody = document.getElementById('cashiers-list-body'); 
        if (!tbody) return;
        tbody.innerHTML = "";
        const data = snapshot.val();

        if (!data) {
            const noDataMsg = currentLang === 'ar' ? 'لا يوجد كاشير مضاف' : 'No cashiers added';
            tbody.innerHTML = `<tr><td colspan="3">${noDataMsg}</td></tr>`;
            return;
        }

        for (let pin in data) {
            const c = data[pin];
            tbody.innerHTML += `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.pin}</td>
                    <td>
                        <button class="btn-main edit-cashier-btn" 
                                data-pin="${c.pin}" 
                                data-name="${c.name}">
                            ${lang.edit}
                        </button> 
                        <button class="btn-clear delete-cashier-btn" 
                                data-pin="${c.pin}">
                            ${lang.delete}
                        </button>
                    </td>
                </tr>`;
        }
    });
};

    window.initUsersLogic = function() {
    onValue(ref(database, 'system_users'), (snapshot) => {
        const tbody = document.getElementById('users-list-body');
        if (!tbody) return;
        tbody.innerHTML = "";

        // 1. استدعاء اللغة الحالية من القاموس
        const lang = translations[currentLang]; 

        const data = snapshot.val();
        for (let pin in data) {
            const u = data[pin];
            tbody.innerHTML += `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.role}</td>
                    <td>${u.pin}</td>
                    <td>
                        <button class="btn-main edit-user-btn" 
                                data-pin="${u.pin}" 
                                data-name="${u.name}" 
                                data-role="${u.role}">
                            ${lang.edit}
                        </button> 
                        
                        <button class="btn-clear delete-user-btn" 
                                data-pin="${u.pin}">
                            ${lang.delete}
                        </button>
                    </td>
                </tr>`;
        }
    });
};

    window.listenToBranches = function() {
    onValue(ref(database, 'branches'), (snapshot) => {
        const tbody = document.getElementById('branches-list-body');
        if (!tbody) return;
        tbody.innerHTML = "";

        const lang = translations[currentLang]; 

        const data = snapshot.val();
        if (!data) { 
            tbody.innerHTML = `<tr><td colspan='4'>${currentLang === 'ar' ? 'لا توجد فروع مضافة' : 'No branches added'}</td></tr>`; 
            return; 
        }

        for (let id in data) {
            const b = data[id];
            // تحديد النص بناءً على نوع الفرع واللغة
            const branchType = b.isMain 
                ? (currentLang === 'ar' ? 'رئيسي ★' : 'Main ★') 
                : (currentLang === 'ar' ? 'فرعي' : 'Sub-Branch');

            tbody.innerHTML += `
                <tr>
                    <td>${b.nameAr}</td>
                    <td>${b.nameEn}</td>
                    <td>${branchType}</td>
                    <td>
                        <button class="btn-main edit-branch-btn" 
                                data-id="${id}" 
                                data-ar="${b.nameAr}" 
                                data-en="${b.nameEn}" 
                                data-main="${b.isMain}">
                            ${lang.edit}
                        </button>
                        <button class="btn-clear delete-branch-btn" 
                                data-id="${id}">
                            ${lang.delete}
                        </button>
                    </td>
                </tr>`;
        }
    });
};

    // 3. محرك تسجيل الدخول (فحص الرموز من 4 أرقام)
    window.verifyUserLogin = async function(enteredPin) {
        const errorMsg = document.getElementById('login-error');
        if (enteredPin === "123456") { // رمز الطوارئ
            sessionStorage.setItem('userRole', 'admin');
            sessionStorage.setItem('userName', 'المدير العام');
            location.reload(); return;
        }
        try {
            const userSnap = await get(ref(database, 'system_users/' + enteredPin));
            if (userSnap.exists()) {
                const u = userSnap.val();
                sessionStorage.setItem('userRole', u.role);
                sessionStorage.setItem('userName', u.name);
                location.reload(); return;
            }
            const cashierSnap = await get(ref(database, 'cashiers/' + enteredPin));
            if (cashierSnap.exists()) {
                const c = cashierSnap.val();
                sessionStorage.setItem('userRole', 'أمين صندوق');
                sessionStorage.setItem('userName', c.name);
                location.reload(); return;
            }
            errorMsg.style.display = "block";
        } catch (e) { alert("خطأ في الاتصال"); }
    };

    // 4. وظائف الحفظ (المستخدمين والكاشير والفروع)
    window.confirmSaveUser = async function() {
        const name = document.getElementById('user-name-input').value;
        const role = document.getElementById('user-role-select').value;
        const pin = document.getElementById('user-pin-input').value;
        if (!name || !pin) return alert("يرجى إكمال البيانات");
        await set(ref(database, 'system_users/' + pin), { name, role, pin, createdAt: new Date().toISOString() });
        closeModal();
    };

    window.saveNewCashier = async function() {
        const name = document.getElementById('cashier-name-input').value;
        const pin = document.getElementById('cashier-pin-input').value;
        if (!name || !pin) return alert("يرجى إكمال بيانات الكاشير");
        await set(ref(database, 'cashiers/' + pin), { name, pin, createdAt: new Date().toISOString() });
        closeModal();
    };

    // محرك صيد النقرات المطور لإصلاح أزرار التعديل والحذف
    document.addEventListener('click', async (e) => {
    const t = e.target;
    // استدعاء قاموس اللغة الحالية لتسهيل الاستخدام
    const lang = translations[currentLang];

    // تعديل منطقة توصيل
    if (t.closest('.edit-area-btn')) {
        const btn = t.closest('.edit-area-btn');
        window.openEditAreaModal(btn.dataset.id, btn.dataset.ar, btn.dataset.en, btn.dataset.price);
    }

    // حذف منطقة توصيل
    if (t.closest('.delete-area-btn')) {
        const btn = t.closest('.delete-area-btn');
        if (confirm(lang.deleteConfirm)) {
            await set(ref(database, 'delivery_areas/' + btn.dataset.id), null);
        }
    }

    // 1. تعديل مستخدم (المحاسبة)
    if (t.closest('.edit-user-btn')) {
        const btn = t.closest('.edit-user-btn');
        window.openEditUserModal(btn.dataset.pin, btn.dataset.name, btn.dataset.role);
    }

    // 2. تعديل كاشير (المبيعات)
    if (t.closest('.edit-cashier-btn')) {
        const btn = t.closest('.edit-cashier-btn');
        window.openEditCashierModal(btn.dataset.pin, btn.dataset.name);
    }

    // 3. حذف كاشير (استخدام الترجمة في رسالة التأكيد)
    if (t.closest('.delete-cashier-btn')) {
        const btn = t.closest('.delete-cashier-btn');
        // استخدام المفتاح deleteConfirm من القاموس
        if (confirm(lang.deleteConfirm)) { 
            await set(ref(database, 'cashiers/' + btn.dataset.pin), null);
        }
    }

    // 4. حذف مستخدم (استخدام الترجمة في رسالة التأكيد)
    if (t.closest('.delete-user-btn')) {
        const btn = t.closest('.delete-user-btn');
        if (confirm(lang.deleteConfirm)) { 
            await set(ref(database, 'system_users/' + btn.dataset.pin), null);
        }
    }

    // 5. ربط جهاز
    if (t.closest('.link-device-btn')) {
        const btn = t.closest('.link-device-btn');
        window.openEditDeviceModal(btn.dataset.id, btn.dataset.name);
    }
    
    // 6. تعديل فرع وحذفه (استخدام الترجمة في رسالة التأكيد)
    if (t.closest('.edit-branch-btn')) {
        const btn = t.closest('.edit-branch-btn');
        window.openEditBranchModal(btn.dataset.id, btn.dataset.ar, btn.dataset.en, btn.dataset.main);
    }
    if (t.closest('.delete-branch-btn')) {
        const btn = t.closest('.delete-branch-btn');
        if (confirm(lang.deleteConfirm)) { 
            await set(ref(database, 'branches/' + btn.dataset.id), null);
        }
    }
});

    // 6. الصلاحيات وفحص الجهاز
    window.applyRolePermissions = function(role) {
        document.querySelectorAll('.sidebar-item, .dropdown-btn').forEach(el => el.style.setProperty('display', 'block', 'important'));
        const hidden = { 'أمين صندوق': ['#drop-stores', '#drop-suppliers'], 'أمين مخازن': ['#drop-admin'] };
        if (hidden[role]) hidden[role].forEach(s => document.querySelectorAll(s).forEach(el => el.style.setProperty('display', 'none', 'important')));
    };

    const role = sessionStorage.getItem('userRole');
    if (role) {
        window.applyRolePermissions(role);
        let deviceID = localStorage.getItem('fawatirr_device_id') || 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
        localStorage.setItem('fawatirr_device_id', deviceID);
        update(ref(database, 'authorized_devices/' + deviceID), { status: 'online', lastSeen: new Date().toLocaleString() });
    }


     // دالة التحديث الفعلي للمستخدم في Firebase
    window.updateUserInFirebase = async function(pin, name, role) {
        try {
            await update(ref(database, 'system_users/' + pin), { name, role });
            alert("✅ تم تحديث بيانات المستخدم بنجاح");
            closeModal();
        } catch (e) { alert("خطأ في التحديث: " + e.message); }
    };

    // دالة التحديث الفعلي للكاشير في Firebase
    window.updateCashierInFirebase = async function(pin, name) {
        try {
            await update(ref(database, 'cashiers/' + pin), { name });
            alert("✅ تم تحديث بيانات الكاشير بنجاح");
            closeModal();
        } catch (e) { alert("خطأ في التحديث: " + e.message); }
    };


// --- دالة عرض البيانات الموحدة والمترجمة ---
window.initDeliveryAreasLogic = function() {
    const lang = translations[currentLang]; // استدعاء القاموس لترجمة الأزرار
    
    onValue(ref(database, 'delivery_areas'), (snapshot) => {
        const tbody = document.getElementById('delivery-areas-list');
        if (!tbody) return;
        tbody.innerHTML = "";
        const data = snapshot.val();
        
        // فحص حالة قاعدة البيانات الفارغة
        if (!data) {
            tbody.innerHTML = `<tr><td colspan="4">${currentLang === 'ar' ? 'لا توجد مناطق مضافة' : 'No areas added'}</td></tr>`;
            return;
        }

        for (let id in data) {
            const area = data[id];
            tbody.innerHTML += `
                <tr>
                    <td>${area.nameAr}</td>
                    <td>${area.nameEn}</td>
                    <td>${parseFloat(area.price).toFixed(3)} ${currentLang === 'ar' ? 'د.ك' : 'KD'}</td>
                    <td>
                        <button class="btn-main edit-area-btn" 
                                data-id="${id}" 
                                data-ar="${area.nameAr}" 
                                data-en="${area.nameEn}" 
                                data-price="${area.price}">
                            ${lang.edit}
                        </button>
                        <button class="btn-clear delete-area-btn" data-id="${id}">
                            ${lang.delete}
                        </button>
                    </td>
                </tr>`;
        }
    });
};

// وظيفة حفظ المنطقة في فايربيس
window.confirmSaveArea = async function() {
    const nameAr = document.getElementById('area-name-ar').value;
    const nameEn = document.getElementById('area-name-en').value;
    const price = document.getElementById('area-price').value;
    
    if(!nameAr || !price) return alert(currentLang === 'ar' ? "أكمل البيانات" : "Complete data");
    
    const id = Date.now();
    await set(ref(database, 'delivery_areas/' + id), { nameAr, nameEn, price });
    alert(translations[currentLang].saveSuccess);
    closeModal();
};


window.updateAreaInFirebase = async function(id, nameAr, nameEn, price) {
    try {
        await update(ref(database, 'delivery_areas/' + id), { nameAr, nameEn, price });
        alert(translations[currentLang].saveSuccess);
        closeModal();
    } catch (e) { alert("Error: " + e.message); }
};


</script>
</body>
</html>
