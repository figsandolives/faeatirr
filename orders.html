<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script src="lang.js"></script>
  <script src="main.js" defer></script>
</head>

<body>
  <div class="side-menu">
    <div class="menu-header">
      <img src="logo.png" class="mini-logo" />
      <h2 data-key="ordersPageTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    </div>
    <button onclick="window.location.href='accounting.html'" class="main-btn" style="width:90%;margin:auto;">â†© Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
  </div>

  <div class="main-content">
    <h1 data-key="ordersList">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
    <button id="toggleLangOrder" class="lang-btn">English</button>

    <div class="filter-box">
      <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="fromDate" />
      <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
      <input type="date" id="toDate" />
      <select id="filterBranch"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹</option></select>
      <select id="filterCashier"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø´ÙŠØ±Ø§Øª</option></select>
      <select id="filterZone"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option></select>
      <button onclick="applyFilter()" class="main-btn">ÙÙ„ØªØ±Ø©</button>
    </div>

    <div class="table-controls">
  <button onclick="downloadExcel()" class="main-btn" data-key="downloadExcel">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Excel</button>
  <button onclick="printOrders()" class="main-btn" data-key="printAll">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒÙ„</button>
  <label><input type="checkbox" id="selectAll" onchange="selectAllOrders(this)"> <span data-key="selectAll">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span></label>
</div>

    <table id="ordersTable">
      <thead>
  <tr>
    <th></th>
    <th data-key="invoiceNo">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
    <th data-key="customerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
    <th data-key="zone">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</th>
    <th data-key="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
    <th data-key="dateTime">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
    <th data-key="cashierName">Ø§Ù„ÙƒØ§Ø´ÙŠØ±</th>
    <th data-key="branchName">Ø§Ù„ÙØ±Ø¹</th>
    <th data-key="netTotal">ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
    <th data-key="deliveryFee">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</th>
    <th data-key="total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
    <th data-key="payment">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
    <th data-key="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    
   document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    if (localStorage.getItem("adminLoggedIn") !== "true") {
      window.location.href = "login.html";
    }
  }, 400); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· ÙŠÙ…Ù†Ø¹ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ù„Ù‚Ø©
});

    // âœ… Ø±Ø¨Ø· Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBdDFbWuByBWsDqEmC18nSlIKG6QZ5s0wA",
      authDomain: "fawatirr-75242.firebaseapp.com",
      databaseURL: "https://fawatirr-75242-default-rtdb.firebaseio.com",
      projectId: "fawatirr-75242",
      storageBucket: "fawatirr-75242.firebasestorage.app",
      messagingSenderId: "1059799456100",
      appId: "1:1059799456100:web:d624eb6f98aaee78950271",
      measurementId: "G-7SQXEJQY6Y"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let orders = [];
    let filtered = [];

    const tableBody = document.querySelector("#ordersTable tbody");

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Firebase
    db.ref("orders").on("value", snap => {
      const data = snap.val();
      orders = [];
      for (const id in data) {
        orders.push({...data[id], id});
      }
      filtered = [...orders];
      renderTable(orders);
    });

    // âœ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function renderTable(list) {
      tableBody.innerHTML = "";
      list.forEach(order => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" class="orderCheck" data-id="${order.id}"></td>
          <td>${order.invoice_no || "-"}</td>
          <td>${order.customer_name || "-"}</td>
          <td>${order.delivery_zone || "-"}</td>
          <td>${order.customer_phone || "-"}</td>
          <td>${order.date || "-"}</td>
          <td>${order.cashier_name || "-"}</td>
          <td>${order.branch_name || "-"}</td>
          <td>${order.net_total || 0}</td>
          <td>${order.delivery_fee || 0}</td>
          <td>${order.total || 0}</td>
          <td>${order.payment_method || "-"}</td>
          <td>
  <button class="editBtn" data-key="edit" onclick="editOrder('${order.id}')">${translations[currentLang].edit}</button>
  <button class="delBtn" data-key="delete" onclick="deleteOrder('${order.id}')">ğŸ—‘ï¸ ${translations[currentLang].delete}</button>
</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„
    function selectAllOrders(chk) {
      document.querySelectorAll(".orderCheck").forEach(c => {
        c.checked = chk.checked;
      });
    }

    // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function applyFilter() {
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;
      filtered = orders.filter(o => {
        const d = new Date(o.date);
        return (!from || new Date(from) <= d) && (!to || d <= new Date(to));
      });
      renderTable(filtered);
    }

    // âœ… Ø­Ø°Ù Ø·Ù„Ø¨
    function deleteOrder(id) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")) return;
      db.ref("orders/" + id).remove().then(() => alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨"));
    }

    // âœ… ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ (Ù…ÙƒØ§Ù†ÙŠØ§Ù‹ ÙÙ‚Ø· â€“ ØªØ·ÙˆÙŠØ± Ù„Ø§Ø­Ù‚ Ø¨Ù„ÙˆØ­Ø© ØªØ­Ø±ÙŠØ±)
    function editOrder(id) {
      alert("Ø®Ø§ØµÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø³ØªÙÙØ¹Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Excel
    function downloadExcel() {
      const data = filtered.map(o => ({
        "Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©": o.invoice_no,
        "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„": o.customer_name,
        "Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„": o.delivery_zone,
        "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ": o.customer_phone,
        "Ø§Ù„ØªØ§Ø±ÙŠØ®": o.date,
        "Ø§Ù„ÙƒØ§Ø´ÙŠØ±": o.cashier_name,
        "Ø§Ù„ÙØ±Ø¹": o.branch_name,
        "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ": o.total
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Orders");
      XLSX.writeFile(wb, "Orders_Report.xlsx");
    }

    // âœ… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    function printOrders() {
      const selected = Array.from(document.querySelectorAll(".orderCheck:checked")).map(input =>
        orders.find(o => o.id === input.dataset.id)
      );
      const list = selected.length ? selected : filtered;
      const win = window.open("", "_blank");
      win.document.write("<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</title></head><body>");
      list.forEach(o => {
        win.document.write(`
          <div style='page-break-after: always; border:1px solid #ccc; padding:10px; margin:15px;'>
            <h2>ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: ${o.invoice_no}</h2>
            <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${o.customer_name}</p>
            <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${o.branch_name}</p>
            <p><strong>Ø§Ù„ÙƒØ§Ø´ÙŠØ±:</strong> ${o.cashier_name}</p>
            <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${o.total}</p>
          </div>
        `);
      });
      win.document.write("</body></html>");
      win.document.close();
      win.print();
    }


    // âœ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
let currentLang = localStorage.getItem("lang") || "ar";

function updateOrdersLang() {
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";

  document.querySelectorAll("[data-key]").forEach(el => {
    const key = el.getAttribute("data-key");
    if (translations[currentLang][key]) {
      el.textContent = translations[currentLang][key];
    }
  });

  document.getElementById("toggleLangOrder").textContent =
    currentLang === "ar" ? "English" : "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
  renderTable(filtered);
}

document.getElementById("toggleLangOrder").addEventListener("click", () => {
  currentLang = currentLang === "ar" ? "en" : "ar";
  localStorage.setItem("lang", currentLang);
  updateOrdersLang();
});

updateOrdersLang();


  </script>
</body>
</html>
